<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Chenjf&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Chenjf&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chen Jianfeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Chenjf's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Chenjf's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chen Jianfeng"
      src="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
  <p class="site-author-name" itemprop="name">Chen Jianfeng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/24/20210723_DApp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/24/20210723_DApp/" class="post-title-link" itemprop="url">DApp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-24 17:15:15" itemprop="dateCreated datePublished" datetime="2021-07-24T17:15:15+08:00">2021-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-26 08:53:51" itemprop="dateModified" datetime="2021-07-26T08:53:51+08:00">2021-07-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/07/24/20210723_DApp/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/24/20210723_DApp/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="以太坊客户端安装"><a href="#以太坊客户端安装" class="headerlink" title="以太坊客户端安装"></a>以太坊客户端安装</h2><p><a target="_blank" rel="noopener" href="https://ethereumdocch.readthedocs.io/zh/latest/ethereum-clients/index.html">以太坊客户端介绍</a></p>
<p>我们选择其中一个主流的客户端go-ethereum（Geth）进行安装。以Windows为例：<br>执行：<br><code>pkg install go-ethereum</code></p>
<p><a target="_blank" rel="noopener" href="https://geth.ethereum.org/docs/install-and-build/installing-geth">其他环境安装</a></p>
<h2 id="链搭建"><a href="#链搭建" class="headerlink" title="链搭建"></a>链搭建</h2><p>以搭建私链为例：</p>
<ol>
<li><p>新建目录（eth-pri）</p>
</li>
<li><p>执行启动命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth --datadir ether-pri --rpcapi=&quot;db,eth,net,web3,miner,personal,web3&quot; --http --dev --dev.period 10 --http.corsdomain &quot;https://remix.ethereum.org,http://remix.ethereum.org&quot;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://geth.ethereum.org/docs/interface/command-line-options">参数说明</a></p>
</li>
<li><p>连接客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth attach http://localhost:8545</span><br></pre></td></tr></table></figure></li>
<li><p>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">账号</span><br><span class="line">    创建：personal.newAccount()</span><br><span class="line">    获取账号：eth.accounts</span><br><span class="line">    获取余额：eth.getBalance(&quot;sssss&quot;)</span><br><span class="line">    解锁账号：personal.unlockAccount(user1,password)</span><br><span class="line"></span><br><span class="line">挖矿</span><br><span class="line">    开始：miner.start()</span><br><span class="line">    结束：miner.stop()</span><br><span class="line">    设置挖矿奖励用户：miner.setEtherbase(user3)</span><br><span class="line"></span><br><span class="line">转账</span><br><span class="line">    u1 = eth.accounts[0]</span><br><span class="line">    u2 = eth.accounts[1]</span><br><span class="line">    eth.sendTransaction(&#123;from:u1, to:u2, value:web3.toWei(10, &quot;ether&quot;)&#125;)</span><br><span class="line"></span><br><span class="line">交易前解锁账号</span><br><span class="line">    personal.unlockAcount(u1, password)</span><br><span class="line"></span><br><span class="line">交易完需要挖矿来确认</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://web3js.readthedocs.io/en/v1.2.9/">其他命令操作</a> 可以参考Web3js</p>
</li>
</ol>
<h2 id="合约"><a href="#合约" class="headerlink" title="合约"></a>合约</h2><h3 id="合约开发"><a href="#合约开发" class="headerlink" title="合约开发"></a>合约开发</h3><p><a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.6/">solidity英文开发文档</a><br><a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/solidity/index.html">solidity中文开发文档</a></p>
<h3 id="合约编译、部署"><a href="#合约编译、部署" class="headerlink" title="合约编译、部署"></a>合约编译、部署</h3><h4 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a><a target="_blank" rel="noopener" href="https://remix.ethereum.org/">Remix</a></h4><p>remix访问本地：</p>
<ol>
<li>uninstall the old one： <code>npm uninstall -g remixd</code></li>
<li>install the new： <code>npm install -g @remix-project/remixd</code></li>
<li>share folder： <code>remixd -s &lt;absolute-path&gt; --remix-ide https://remix.ethereum.org</code></li>
</ol>
<h4 id="Truffle"><a href="#Truffle" class="headerlink" title="Truffle"></a>Truffle</h4><p><a target="_blank" rel="noopener" href="https://truffle.tryblockchain.org/Solidity-truffle-%e5%ae%9e%e6%88%98.html">文档</a><br><a target="_blank" rel="noopener" href="https://github.com/ChenJFMorton/truffleTest">Truffle、Solidity合约项目Demo</a></p>
<ol>
<li>初始化truffle项目：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">truffle init</span><br></pre></td></tr></table></figure></li>
<li>solidity安装外部依赖：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ERC20依赖</span><br><span class="line">npm install  @openzeppelin/contracts</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="合约调试"><a href="#合约调试" class="headerlink" title="合约调试"></a>合约调试</h3><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1679411">Buidler</a>内置了Buidler EVM ，这是一个专为开发而设计的以太坊网络。它允许你部署合约，运行测试和调试代码。可以将合约部署到buidler-evm上，调试完再部署到实际使用的链上。<br>使用步骤：</p>
<ol>
<li>启动（每次启动貌似起个新链，之前部署的合约都不存在了）<br><code>npx buidler node</code></li>
</ol>
<p>注：</p>
<ol>
<li>支持的solidity版本 &lt; 0.8.0</li>
</ol>
<h3 id="部署到测试链"><a href="#部署到测试链" class="headerlink" title="部署到测试链"></a>部署到测试链</h3><h2 id="前端开发"><a href="#前端开发" class="headerlink" title="前端开发"></a>前端开发</h2><p><a target="_blank" rel="noopener" href="https://github.com/ChenJFMorton/guess">Demo地址</a><br>Vue + Element-Ui + Web3js</p>
<ol>
<li>创建Vue项目<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">安装vue：npm install -g vue-cli</span><br><span class="line">初始化vue项目：vue init webpack my-project</span><br><span class="line">安装web3：npm install web3@1.3.1</span><br><span class="line">启动项目：npm run dev</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Java调用合约"><a href="#Java调用合约" class="headerlink" title="Java调用合约"></a>Java调用合约</h2><ol>
<li><p>pom.xml引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.web3j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.8.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.web3j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;codegen&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.8.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>通过abi文件生成java类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static void transformABI() throws Exception &#123;</span><br><span class="line">    //org.web3j.codegen.TruffleJsonFunctionWrapperGenerator /path/to/&lt;truffle-smart-contract-output&gt;.json -o /path/to/src/main/java -p com.your.organisation.name</span><br><span class="line">    TruffleJsonFunctionWrapperGenerator.main(new String[]&#123;&quot;D:\\developtools\\truffle\\workspace\\truffleTest\\build\\contracts\\GuessVote.json&quot;,&quot;-o&quot;,&quot;D:/git/netease-leihuo/ethereum-test/src/main/java&quot;,&quot;-p&quot;,&quot;com.cjf.web3j.abi&quot;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>合约中方法调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// 默认链接到，或者自己指定 http://localhost:8545/</span><br><span class="line">Web3j web3 = Web3j.build(new HttpService()); </span><br><span class="line">//获取链接到的client的版本</span><br><span class="line">Web3ClientVersion web3ClientVersion = web3.web3ClientVersion().send();</span><br><span class="line">String clientVersion = web3ClientVersion.getWeb3ClientVersion();</span><br><span class="line">System.out.println(clientVersion);</span><br><span class="line"></span><br><span class="line">//获取当前gasprice</span><br><span class="line">EthGasPrice gasPrice = web3.ethGasPrice().send();</span><br><span class="line"></span><br><span class="line">BigInteger priceResult = gasPrice.getGasPrice();</span><br><span class="line">System.out.println(&quot;current gas price:&quot; + priceResult);</span><br><span class="line"></span><br><span class="line">//获取块的gasLimit</span><br><span class="line">EthBlock.Block block = web3.ethGetBlockByNumber(DefaultBlockParameterName.LATEST, false).send().getBlock();</span><br><span class="line">System.out.println(&quot;BLOCK GAS LIMIT:&quot; + block.getGasLimit());</span><br><span class="line"></span><br><span class="line">StaticGasProvider gasProvider = new StaticGasProvider(priceResult, block.getGasLimit());</span><br><span class="line"></span><br><span class="line">//使用私钥创建Credentials</span><br><span class="line">Credentials owner = Credentials.create(&quot;****&quot;);</span><br><span class="line"></span><br><span class="line">//需要指定chainId来创建TransactionManager ，否则交易会因为防重放攻击而无法被执行</span><br><span class="line">TransactionManager transactionManager = new RawTransactionManager(web3, owner, 1337);</span><br><span class="line"></span><br><span class="line">//获取一个链上已经存在的合约</span><br><span class="line">GuessVote guessVote = GuessVote.load(GuessVote.getPreviouslyDeployedAddress(&quot;1337&quot;), web3, transactionManager, gasProvider);</span><br><span class="line"></span><br><span class="line">// 调用合约中的方法</span><br><span class="line">TransactionReceipt s = guessVote.generateVoteResult().send();</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="MetaMask钱包"><a href="#MetaMask钱包" class="headerlink" title="MetaMask钱包"></a>MetaMask钱包</h2><p><a target="_blank" rel="noopener" href="https://docs.metamask.io/guide/getting-started.html">MetaMask文档</a><br>安装：<code>npm install metamask</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 获取最新区块</span><br><span class="line">const newestBlockNum = parseInt(</span><br><span class="line">          await ethereum.request(&#123;</span><br><span class="line">            method: &quot;eth_blockNumber&quot;,</span><br><span class="line">            params: [],</span><br><span class="line">          &#125;),</span><br><span class="line">          16</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">// 获取账号</span><br><span class="line">const accounts = await ethereum.request(&#123;</span><br><span class="line">        method: &quot;eth_requestAccounts&quot;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">// 获取账号余额</span><br><span class="line">const balance = await this.usstContract.methods</span><br><span class="line">          .balanceOf(this.account)</span><br><span class="line">          .call();</span><br></pre></td></tr></table></figure>

<h2 id="部署到测试链-1"><a href="#部署到测试链-1" class="headerlink" title="部署到测试链"></a>部署到测试链</h2><h3 id="币安测试链"><a href="#币安测试链" class="headerlink" title="币安测试链"></a>币安测试链</h3><p><a target="_blank" rel="noopener" href="https://docs.binance.org/smart-chain/developer/rpc.html">文档</a><br><a target="_blank" rel="noopener" href="https://docs.binance.org/smart-chain/wallet/metamask.html">水龙头相关文档</a><br><a target="_blank" rel="noopener" href="https://www.mytokencap.com/announcement/1072241.html">水龙头其他文档</a> </p>
<p>注：ip限制，充值不上换代理。</p>
<p>部署测试链步骤：</p>
<ol>
<li>修改truffle-config.js<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const HDWalletProvider = require(&#x27;@truffle/hdwallet-provider&#x27;);</span><br><span class="line"></span><br><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line">const mnemonic = fs.readFileSync(&quot;.secret&quot;).toString().trim();</span><br></pre></td></tr></table></figure>
networks增加配置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testnet: &#123;</span><br><span class="line">      provider: () =&gt; new HDWalletProvider(mnemonic, `https://data-seed-prebsc-2-s1.binance.org:8545`),</span><br><span class="line">      network_id: 97,</span><br><span class="line">      confirmations: 10,</span><br><span class="line">      timeoutBlocks: 200,</span><br><span class="line">      skipDryRun: true</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>部署命令<br><code>truffle migrate --network testnet</code></li>
</ol>
<h3 id="火币测试链"><a href="#火币测试链" class="headerlink" title="火币测试链"></a>火币测试链</h3><p><a href="www.hecochain.com">官网地址</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">测试网地址：</span><br><span class="line">    chainid 256</span><br><span class="line">    RPC wss://ws-testnet.hecochain.com</span><br><span class="line">    https://http-testnet.hecochain.com</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://scan-testnet.hecochain.com/">浏览器</a><br><a target="_blank" rel="noopener" href="https://scan-testnet.hecochain.com/faucet">测试币水龙头</a></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol>
<li>Exception in thread “main” java.lang.UnsupportedOperationException: Unsupported type encountered: tuple<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://stackoverflow.com/questions/48877910/how-can-i-return-an-array-of-struct-in-solidity</span><br></pre></td></tr></table></figure></li>
<li>合约多字段返回<br>java:元组<br>js:struct[]，调用call方法需要传account<br> <a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/web3.js/web3-eth-contract.html#methods-mymethod-call">参考文档</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/14/20201214_B2C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/14/20201214_B2C/" class="post-title-link" itemprop="url">B2C商城</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-14 17:15:15 / 修改时间：14:28:31" itemprop="dateCreated datePublished" datetime="2020-12-14T17:15:15+08:00">2020-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/12/14/20201214_B2C/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/12/14/20201214_B2C/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="交易状态设计"><a href="#交易状态设计" class="headerlink" title="交易状态设计"></a>交易状态设计</h2><h2 id="下单"><a href="#下单" class="headerlink" title="下单"></a>下单</h2><h2 id="支付"><a href="#支付" class="headerlink" title="支付"></a>支付</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/14/20201214_PM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/14/20201214_PM/" class="post-title-link" itemprop="url">B2C商城</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-12-14 17:15:15 / 修改时间：15:34:51" itemprop="dateCreated datePublished" datetime="2020-12-14T17:15:15+08:00">2020-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/12/14/20201214_PM/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/12/14/20201214_PM/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/20200804_invertedIndex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/20200804_invertedIndex/" class="post-title-link" itemprop="url">搜索引擎是如何实现快速查询？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 15:15:15" itemprop="dateCreated datePublished" datetime="2020-08-04T15:15:15+08:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-30 11:39:50" itemprop="dateModified" datetime="2020-10-30T11:39:50+08:00">2020-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/04/20200804_invertedIndex/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/04/20200804_invertedIndex/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么需要搜索引擎？"><a href="#为什么需要搜索引擎？" class="headerlink" title="为什么需要搜索引擎？"></a>为什么需要搜索引擎？</h2><p>用数据库，也可以实现搜索的功能，为什么还需要搜索引擎呢？</p>
<p>就像 <a href="https://link.zhihu.com/?target=https://stackoverflow.com/questions/51639166/elasticsearch-vs-relational-database">Stackoverflow</a> 的网友说的：</p>
<blockquote>
<p>A relational database can store data and also index it. A search engine can index data but also store it.</p>
</blockquote>
<p>数据库（理论上来讲，ES 也是数据库，这里的数据库，指的是关系型数据库），首先是存储，搜索只是顺便提供的功能，</p>
<p>而搜索引擎，首先是搜索，但是不把数据存下来就搜不了，所以只好存一存。</p>
<p>术业有专攻，专攻搜索的搜索引擎，自然会提供更强大的搜索能力。</p>
<h2 id="搜索引擎凭什么比关系型数据库查询快？"><a href="#搜索引擎凭什么比关系型数据库查询快？" class="headerlink" title="搜索引擎凭什么比关系型数据库查询快？"></a>搜索引擎凭什么比关系型数据库查询快？</h2><p>Elasticsearch 是通过 Lucene 的倒排索引技术实现比关系型数据库更快的过滤。特别是它对多条件的过滤支持非常好，比如年龄在 18 和 30 之间，性别为女性这样的组合查询。倒排索引很多地方都有介绍，</p>
<p>笼统的来说，<a href="%5Bhttps://zh.wikipedia.org/wiki/B+%E6%A0%91%5D(https://zh.wikipedia.org/wiki/B+%E6%A0%91)"><strong>b-tree</strong></a> 索引是为写入优化的索引结构。当我们不需要支持快速的更新的时候，可以用预先排序等方式换取更小的存储空间，更快的检索速度等好处，其代价就是更新慢。要进一步深入的化，还是要看一下 Lucene 的倒排索引是怎么构成的。</p>
<p>先看倒排索引的构成</p>
<p><img src="https://pic.downk.cc/item/5f2a219314195aa594b7dd8a.jpg"></p>
<p>这里对应的名字概念，举个实际的例子</p>
<table>
<thead>
<tr>
<th>docid</th>
<th>age</th>
<th>sex</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
<td>女</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>女</td>
</tr>
<tr>
<td>3</td>
<td>18</td>
<td>男</td>
</tr>
</tbody></table>
<p>这里每一行是一个 document。每个 document 都有一个 docid。那么给这些 document 建立的倒排索引就是：age和sex</p>
<p>可以看到，倒排索引是 per field 的，一个字段有一个自己的倒排索引。18,20 这些叫做 term，而 [1,3] 就是 posting list。Posting list 就是一个 int 的数组，存储了所有符合某个 term 的文档 id。那么什么是 term dictionary 和 term index？</p>
<p>假设我们有很多个 term，比如：</p>
<p><strong>Carla,Sara,Elin,Ada,Patty,Kate,Selena</strong></p>
<p>如果按照这样的顺序排列，找出某个特定的 term 一定很慢，因为 term 没有排序，需要全部过滤一遍才能找出特定的 term。排序之后就变成了：</p>
<p><strong>Ada,Carla,Elin,Kate,Patty,Sara,Selena</strong></p>
<p>这样我们可以用二分查找的方式，比全遍历更快地找出目标的 term。这个就是 term dictionary。有了 term dictionary 之后，可以用 logN 次磁盘查找得到目标。但是磁盘的随机读操作仍然是非常昂贵的（一次 random access 大概需要 10ms 的时间）。所以尽量少的读磁盘，有必要把一些数据缓存到内存里。但是整个 term dictionary 本身又太大了，无法完整地放到内存里。于是就有了 term index。term index 有点像一本字典的目录。比如：</p>
<p>A 开头的 term ……………. Xxx 页</p>
<p>C 开头的 term ……………. Xxx 页</p>
<p>E 开头的 term ……………. Xxx 页</p>
<p>实际的 term index 是一棵 trie 树：</p>
<p><img src="https://pic.downk.cc/item/5f2a64bb14195aa594d9ddc0.png"></p>
<p>例子是一个包含 “A”, “to”, “tea”, “ted”, “ten”, “i”, “in”, 和 “inn” 的 trie 树。这棵树不会包含所有的 term，它包含的是 term 的一些前缀。通过 term index 可以快速地定位到 term dictionary 的某个 offset，然后从这个位置再往后顺序查找。再加上一些压缩技术（搜索 <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/572795">Lucene Finite State Transducers</a>） term index 的尺寸可以只有所有 term 的尺寸的几十分之一，使得用内存缓存整个 term index 变成可能。整体上来说就是这样的效果。</p>
<p><img src="https://pic.downk.cc/item/5f2a68f714195aa594dc032c.jpg"></p>
<p>现在我们可以回答“为什么 Elasticsearch/Lucene 检索可以比 mysql 快了。Mysql 只有 term dictionary 这一层，是以 b-tree 排序的方式存储在磁盘上的。检索一个 term 需要若干次的 random access 的磁盘操作。而 Lucene 在 term dictionary 的基础上添加了 term index 来加速检索，term index 以树的形式缓存在内存中。从 term index 查到对应的 term dictionary 的 block 位置之后，再去磁盘上找 term，大大减少了磁盘的 random access 次数。</p>
<p>额外值得一提的两点是：term index 在内存中是以 FST（finite state transducers）的形式保存的，其特点是非常节省内存。Term dictionary 在磁盘上是以分 block 的方式保存的，一个 block 内部利用公共前缀压缩，比如都是 Ab 开头的单词就可以把 Ab 省去。这样 term dictionary 可以比 b-tree 更节约磁盘空间。</p>
<h2 id="如何联合索引查询？"><a href="#如何联合索引查询？" class="headerlink" title="如何联合索引查询？"></a>如何联合索引查询？</h2><p>所以给定查询过滤条件 age=18 的过程就是先从 term index 找到 18 在 term dictionary 的大概位置，然后再从 term dictionary 里精确地找到 18 这个 term，然后得到一个 posting list 或者一个指向 posting list 位置的指针。然后再查询 gender= 女 的过程也是类似的。最后得出 age=18 AND gender= 女 就是把两个 posting list 做一个“与”的合并。</p>
<p>这个理论上的“与”合并的操作可不容易。对于 mysql 来说，如果你给 age 和 gender 两个字段都建立了索引，查询的时候只会选择其中最 selective 的来用，然后另外一个条件是在遍历行的过程中在内存中计算之后过滤掉。那么要如何才能联合使用两个索引呢？有两种办法：</p>
<ul>
<li>使用 skip list 数据结构。同时遍历 gender 和 age 的 posting list，互相 skip；</li>
<li>使用 bitset 数据结构，对 gender 和 age 两个 filter 分别求出 bitset，对两个 bitset 做 AN 操作。</li>
</ul>
<p>PostgreSQL 从 8.4 版本开始支持通过 bitmap 联合使用两个索引，就是利用了 bitset 数据结构来做到的。当然一些商业的关系型数据库也支持类似的联合索引的功能。Elasticsearch 支持以上两种的联合索引方式，如果查询的 filter 缓存到了内存中（以 bitset 的形式），那么合并就是两个 bitset 的 AND。如果查询的 filter 没有缓存，那么就用 skip list 的方式去遍历两个 on disk 的 posting list。</p>
<h3 id="利用-Skip-List-合并"><a href="#利用-Skip-List-合并" class="headerlink" title="利用 Skip List 合并"></a>利用 Skip List 合并</h3><p><img src="https://pic.downk.cc/item/5f2a695414195aa594dc2f73.jpg"></p>
<p>以上是三个 posting list。我们现在需要把它们用 AND 的关系合并，得出 posting list 的交集。首先选择最短的 posting list，然后从小到大遍历。遍历的过程可以跳过一些元素，比如我们遍历到绿色的 13 的时候，就可以跳过蓝色的 3 了，因为 3 比 13 要小。</p>
<p>整个过程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Next -&gt; 2</span><br><span class="line">Advance(2) -&gt; 13</span><br><span class="line">Advance(13) -&gt; 13</span><br><span class="line">Already on 13</span><br><span class="line">Advance(13) -&gt; 13 MATCH!!!</span><br><span class="line">Next -&gt; 17</span><br><span class="line">Advance(17) -&gt; 22</span><br><span class="line">Advance(22) -&gt; 98</span><br><span class="line">Advance(98) -&gt; 98</span><br><span class="line">Advance(98) -&gt; 98 MATCH!!!</span><br></pre></td></tr></table></figure>

<p>最后得出的交集是 [13,98]，所需的时间比完整遍历三个 posting list 要快得多。但是前提是每个 list 需要指出 Advance 这个操作，快速移动指向的位置。什么样的 list 可以这样 Advance 往前做蛙跳？skip list：</p>
<p><img src="https://pic.downk.cc/item/5f2a69b514195aa594dc60f9.png"></p>
<p>从概念上来说，对于一个很长的 posting list，比如：</p>
<p>[1,3,13,101,105,108,255,256,257]</p>
<p>我们可以把这个 list 分成三个 block：</p>
<p>[1,3,13] [101,105,108] [255,256,257]</p>
<p>然后可以构建出 skip list 的第二层：</p>
<p>[1,101,255]</p>
<p>1,101,255 分别指向自己对应的 block。这样就可以很快地跨 block 的移动指向位置了。</p>
<p>Lucene 自然会对这个 block 再次进行压缩。其压缩方式叫做 Frame Of Reference 编码。示例如下：</p>
<p><img src="https://pic.downk.cc/item/5f2a69dd14195aa594dc74dd.png"></p>
<p>考虑到频繁出现的 term（所谓 low cardinality 的值），比如 gender 里的男或者女。如果有 1 百万个文档，那么性别为男的 posting list 里就会有 50 万个 int 值。用 Frame of Reference 编码进行压缩可以极大减少磁盘占用。这个优化对于减少索引尺寸有非常重要的意义。当然 mysql b-tree 里也有一个类似的 posting list 的东西，是未经过这样压缩的。</p>
<p>因为这个 Frame of Reference 的编码是有解压缩成本的。利用 skip list，除了跳过了遍历的成本，也跳过了解压缩这些压缩过的 block 的过程，从而节省了 cpu。</p>
<h3 id="利用-bitset-合并"><a href="#利用-bitset-合并" class="headerlink" title="利用 bitset 合并"></a>利用 bitset 合并</h3><p>Bitset 是一种很直观的数据结构，对应 posting list 如：</p>
<p>[1,3,4,7,10]</p>
<p>对应的 bitset 就是：</p>
<p>[1,0,1,1,0,0,1,0,0,1]</p>
<p>每个文档按照文档 id 排序对应其中的一个 bit。Bitset 自身就有压缩的特点，其用一个 byte 就可以代表 8 个文档。所以 100 万个文档只需要 12.5 万个 byte。但是考虑到文档可能有数十亿之多，在内存里保存 bitset 仍然是很奢侈的事情。而且对于个每一个 filter 都要消耗一个 bitset，比如 age=18 缓存起来的话是一个 bitset，18&lt;=age&lt;25 是另外一个 filter 缓存起来也要一个 bitset。</p>
<p>所以秘诀就在于需要有一个数据结构：</p>
<ul>
<li>可以很压缩地保存上亿个 bit 代表对应的文档是否匹配 filter；</li>
<li>这个压缩的 bitset 仍然可以很快地进行 AND 和 OR 的逻辑操作。</li>
</ul>
<p>Lucene 使用的这个数据结构叫做 Roaring Bitmap。</p>
<p><img src="https://pic.downk.cc/item/5f2a6a3914195aa594dca6d4.png"></p>
<p>其压缩的思路其实很简单。与其保存 100 个 0，占用 100 个 bit。还不如保存 0 一次，然后声明这个 0 重复了 100 遍。</p>
<p>这两种合并使用索引的方式都有其用途。Elasticsearch 对其性能有详细的对比（<a target="_blank" rel="noopener" href="https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps"> https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps </a>）。简单的结论是：因为 Frame of Reference 编码是如此 高效，对于简单的相等条件的过滤缓存成纯内存的 bitset 还不如需要访问磁盘的 skip list 的方式要快。</p>
<h3 id="如何减少文档数？"><a href="#如何减少文档数？" class="headerlink" title="如何减少文档数？"></a>如何减少文档数？</h3><p>一种常见的压缩存储时间序列的方式是把多个数据点合并成一行。Opentsdb 支持海量数据的一个绝招就是定期把很多行数据合并成一行，这个过程叫 compaction。类似的 vivdcortext 使用 mysql 存储的时候，也把一分钟的很多数据点合并存储到 mysql 的一行里以减少行数。</p>
<p>这个过程可以示例如下：</p>
<table>
<thead>
<tr>
<th>12:05:00</th>
<th>10</th>
</tr>
</thead>
<tbody><tr>
<td>12:05:01</td>
<td>15</td>
</tr>
<tr>
<td>12:05:02</td>
<td>14</td>
</tr>
<tr>
<td>12:05:03</td>
<td>16</td>
</tr>
</tbody></table>
<p>合并之后就变成了：</p>
<p>可以看到，行变成了列了。每一列可以代表这一分钟内一秒的数据。</p>
<p>Elasticsearch 有一个功能可以实现类似的优化效果，那就是 Nested Document。我们可以把一段时间的很多个数据点打包存储到一个父文档里，变成其嵌套的子文档。示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;timestamp:12:05:01, idc:sz, value1:10,value2:11&#125;</span><br><span class="line">&#123;timestamp:12:05:02, idc:sz, value1:9,value2:9&#125;</span><br><span class="line">&#123;timestamp:12:05:02, idc:sz, value1:18,value:17&#125;</span><br></pre></td></tr></table></figure>

<p>可以打包成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">max_timestamp:12:05:02, min_timestamp: 1205:01, idc:sz,</span><br><span class="line">records: [</span><br><span class="line">        &#123;timestamp:12:05:01, value1:10,value2:11&#125;</span><br><span class="line">&#123;timestamp:12:05:02, value1:9,value2:9&#125;</span><br><span class="line">&#123;timestamp:12:05:02, value1:18,value:17&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样可以把数据点公共的维度字段上移到父文档里，而不用在每个子文档里重复存储，从而减少索引的尺寸。</p>
<p><img src="https://pic.downk.cc/item/5f2a6aa214195aa594dcd694.png"></p>
<p>（图片来源：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Su5SHc_uJw8"> https://www.youtube.com/watch?v=Su5SHc_uJw8 </a>，Faceting with Lucene Block Join Query）</p>
<p>在存储的时候，无论父文档还是子文档，对于 Lucene 来说都是文档，都会有文档 Id。但是对于嵌套文档来说，可以保存起子文档和父文档的文档 id 是连续的，而且父文档总是最后一个。有这样一个排序性作为保障，那么有一个所有父文档的 posting list 就可以跟踪所有的父子关系。也可以很容易地在父子文档 id 之间做转换。把父子关系也理解为一个 filter，那么查询时检索的时候不过是又 AND 了另外一个 filter 而已。前面我们已经看到了 Elasticsearch 可以非常高效地处理多 filter 的情况，充分利用底层的索引。</p>
<p>使用了嵌套文档之后，对于 term 的 posting list 只需要保存父文档的 doc id 就可以了，可以比保存所有的数据点的 doc id 要少很多。如果我们可以在一个父文档里塞入 50 个嵌套文档，那么 posting list 可以变成之前的 1/50。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>时间序列数据库的秘密 (2)——索引：<a target="_blank" rel="noopener" href="https://www.infoq.cn/article/database-timestamp-02/">https://www.infoq.cn/article/database-timestamp-02/</a></p>
<p>为什么需要 Elasticsearch：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/73585202">https://zhuanlan.zhihu.com/p/73585202</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/20201030_dataengineer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/20201030_dataengineer/" class="post-title-link" itemprop="url">数据工程师学习资料</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 15:15:15" itemprop="dateCreated datePublished" datetime="2020-08-04T15:15:15+08:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-30 15:30:26" itemprop="dateModified" datetime="2020-10-30T15:30:26+08:00">2020-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%B8%88/" itemprop="url" rel="index"><span itemprop="name">数据工程师</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/04/20201030_dataengineer/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/04/20201030_dataengineer/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一个英文网站，按照学习次序，列出各种主题最推荐的学习资料。<br><a target="_blank" rel="noopener" href="https://awesomedataengineering.com/">https://awesomedataengineering.com/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/03/20200803_Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/03/20200803_Hexo/" class="post-title-link" itemprop="url">在Github上使用Hexo搭建Blog</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-03 11:15:15" itemprop="dateCreated datePublished" datetime="2020-08-03T11:15:15+08:00">2020-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-10-30 10:49:34" itemprop="dateModified" datetime="2020-10-30T10:49:34+08:00">2020-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/03/20200803_Hexo/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/03/20200803_Hexo/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是个人的笔记记录，非详细的文档介绍。</p>
<h2 id="GitHub创建个人仓库"><a href="#GitHub创建个人仓库" class="headerlink" title="GitHub创建个人仓库"></a>GitHub创建个人仓库</h2><p>点击GitHub中的New repository创建新仓库，仓库名应该为：<strong>用户名</strong>.<a href="https://link.zhihu.com/?target=http://github.io">http://github.io</a> 这个<strong>用户名</strong>使用你的GitHub帐号名称代替，这是固定写法，比如我的仓库名为：<a target="_blank" rel="noopener" href="https://chenjfmorton.github.io/">ChenJFMorton.github.io</a></p>
<h2 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h2><p>过程略</p>
<h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><p>Hexo基于Node.js，Node.js下载地址：<a href="https://link.zhihu.com/?target=https://nodejs.org/en/download/">Download | Node.js</a> 下载安装包，注意安装Node.js会包含环境变量及npm的安装，安装后，检测Node.js是否安装成功，在命令行中输入 node -v </p>
<h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>Hexo就是我们的个人博客网站的框架， 这里需要自己在电脑常里创建一个文件夹，可以命名为Blog，Hexo框架与以后你自己发布的网页都在这个文件夹中。</p>
<p>进入文件夹中，使用npm命令安装Hexo，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli </span><br></pre></td></tr></table></figure>

<p>这个安装时间较长耐心等待，安装完成后，初始化我们的博客，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">npm install </span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/29/20200729_JVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/20200729_JVM/" class="post-title-link" itemprop="url">JVM调优及问题排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-29 17:15:15" itemprop="dateCreated datePublished" datetime="2020-07-29T17:15:15+08:00">2020-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-30 17:46:28" itemprop="dateModified" datetime="2020-07-30T17:46:28+08:00">2020-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/07/29/20200729_JVM/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/07/29/20200729_JVM/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是针对有一定Java虚拟机基础知识后，在实际工作中解决JVM相关问题及如何进行优化，偏方法论。</p>
<h2 id="Java内存区域及收集器介绍"><a href="#Java内存区域及收集器介绍" class="headerlink" title="Java内存区域及收集器介绍"></a>Java内存区域及收集器介绍</h2><center><font color="red">jdk1.7及之前</font></center>

<p><img src="https://pic.downk.cc/item/5f2146e814195aa59465fe0a.png"></p>
<center><font color="red">jdk1.8</font></center>

<p><img src="https://pic.downk.cc/item/5f2146e814195aa59465fe0a.png"></p>
<p>1.8同1.7比，最大的差别就是：<strong>元数据区取代了永久代</strong>。元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代之间最大的区别在于：<strong>元数据空间并不在虚拟机中，而是使用本地内存</strong>。</p>
<p><img src="https://pic.downk.cc/item/5f222aa914195aa594e49ad8.png"></p>
<p>垃圾收集器：</p>
<p>收集算法、垃圾收集器详细介绍：略，待补充。</p>
<p>垃圾收集从2个方面不断的改进：提高垃圾回收效率；提高用户体验（低停顿）；</p>
<p><img src="https://pic.downk.cc/item/5f222c2314195aa594e52e60.png"></p>
<center>HotSpot虚拟机的垃圾收集器（介绍见参考一）</center>
## JVM调优目标

<ul>
<li><p>一、何时需要做jvm调优？</p>
<p>​    1、heap 内存（老年代）持续上涨达到设置的最大内存值；</p>
<p>​    2、Full GC 次数频繁；</p>
<p>​    3、GC 停顿时间过长（超过1秒）；</p>
<p>​    4、应用出现OutOfMemory 等内存异常；</p>
<p>​    5、应用中有使用本地缓存且占用大量内存空间；</p>
<p>​    6、系统吞吐量与响应性能不高或下降。</p>
</li>
<li><p>二、 JVM调优原则</p>
<p>​    1、多数的Java应用不需要在服务器上进行JVM优化；</p>
<p>​    2、多数导致GC问题的Java应用，都不是因为我们参数设置错误，而是代码问题；</p>
<p>​    3、在应用上线之前，先考虑将机器的JVM参数设置到最优（最适合）；</p>
<p>​    4、减少创建对象的数量；</p>
<p>​    5、减少使用全局变量和大对象；</p>
<p>​    6、JVM优化是到最后不得已才采用的手段；</p>
<p>​    7、在实际使用中，分析GC情况优化代码比优化JVM参数更好；</p>
</li>
<li><p>三、 JVM调优目标</p>
<p>​    1、GC低停顿；</p>
<p>​    2、GC低频率；</p>
<p>​    3、低内存占用；</p>
<p>​    4、高吞吐量;</p>
</li>
</ul>
<h2 id="JVM调优参数简介"><a href="#JVM调优参数简介" class="headerlink" title="JVM调优参数简介"></a>JVM调优参数简介</h2><h3 id="堆设置"><a href="#堆设置" class="headerlink" title="堆设置"></a>堆设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-Xmn1200m</td>
<td>设置年轻代大小为1200MB。增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，Sun官方推荐配置为整个堆的3/8</td>
</tr>
<tr>
<td>-Xms4g</td>
<td>初始化堆内存大小为4GB</td>
</tr>
<tr>
<td>-Xmx4g</td>
<td>堆内存最大值为4GB</td>
</tr>
<tr>
<td>-Xss512k</td>
<td>设置每个线程的堆栈大小。JDK5.0以后每个线程堆栈大小为1MB，以前每个线程堆栈大小为256K。应根据应用线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右</td>
</tr>
<tr>
<td>-XX:MaxDirectMemorySize</td>
<td>堆外内存/直接内存的大小，默认为堆内存减去一个Survivor区的大小</td>
</tr>
<tr>
<td>-XX:MaxMetaspaceSize=512m</td>
<td>设置元数据区最大值512M（<font color="red">jdk1.8</font>）</td>
</tr>
<tr>
<td>-XX:MaxPermSize=256m</td>
<td>设置持久代大小为256MB。（<font color="red">jdk1.7及以下</font>）</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold=15</td>
<td>设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论</td>
</tr>
<tr>
<td>-XX:MetaspaceSize=128m</td>
<td>设置元数据区初始值128M（<font color="red">jdk1.8</font>）</td>
</tr>
<tr>
<td>-XX:NewRatio=4</td>
<td>设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1/5</td>
</tr>
<tr>
<td>-XX:PermSize=100m</td>
<td>初始化永久代大小为100MB。（<font color="red">jdk1.7及以下</font>）</td>
</tr>
<tr>
<td>-XX:ReservedCodeCacheSize</td>
<td>JIT编译后二进制代码的存放区，满了之后就不再编译。默认开多层编译240M，可以在JMX里看看CodeCache的大小</td>
</tr>
<tr>
<td>-XX:SurvivorRatio=8</td>
<td>设置年轻代中Eden区与Survivor区的大小比值。设置为8，则两个Survivor区与一个Eden区的比值为2:8，一个Survivor区占整个年轻代的1/10</td>
</tr>
</tbody></table>
<h3 id="GC设置"><a href="#GC设置" class="headerlink" title="GC设置"></a>GC设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+HeapDumpOnOutOfMemoryError</td>
<td>发生内存溢出是进行heap-dump</td>
</tr>
<tr>
<td>-XX:HeapDumpPath=/path/to/java_pid.hprof</td>
<td>这个参数与-XX:+HeapDumpOnOutOfMemoryError共同作用，设置heap-dump时内容输出文件</td>
</tr>
<tr>
<td>-XX:ErrorFile=/path/to/hs_err_pid.log</td>
<td>指定致命错误日志位置。一般在JVM发生致命错误时会输出类似hs_err_pid.log的文件，默认是在工作目录中（如果没有权限，会尝试在/tmp中创建），不过还是自己指定位置更好一些，便于收集和查找，避免丢失</td>
</tr>
<tr>
<td>-XX:StringTableSize=1000003</td>
<td>指定字符串常量池大小，默认值是60013。对Java稍微有点常识的应该知道，字符串是常量，创建之后就不可修改了，这些常量所在的地方叫做字符串常量池。如果自己系统中有很多字符串的操作，且这些字符串值比较固定，在允许的情况下，可以适当调大一些池子大小</td>
</tr>
</tbody></table>
<h3 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h3><p>GC过程可以通过GC日志来提供优化依据。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+PrintGCDetails</td>
<td>启用gc日志打印功能</td>
</tr>
<tr>
<td>-Xloggc:/path/to/gc.log</td>
<td>指定gc日志位置</td>
</tr>
<tr>
<td>-XX:+PrintHeapAtGC</td>
<td>打印GC前后的详细堆栈信息</td>
</tr>
<tr>
<td>-XX:+PrintGCDateStamps</td>
<td>打印可读的日期而不是时间戳</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationStoppedTime</td>
<td>打印所有引起JVM停顿时间，如果真的发现了一些不知什么的停顿，再临时加上-XX:+PrintSafepointStatistics -XX: PrintSafepointStatisticsCount=1找原因</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationConcurrentTime</td>
<td>打印JVM在两次停顿之间正常运行时间，与-XX:+PrintGCApplicationStoppedTime一起使用效果更佳</td>
</tr>
<tr>
<td>-XX:+PrintTenuringDistribution</td>
<td>查看每次minor GC后新的存活周期的阈值</td>
</tr>
<tr>
<td>-XX:+UseGCLogFileRotation 与 -XX:NumberOfGCLogFiles=10 与 -XX:GCLogFileSize=10M</td>
<td>GC日志在重启之后会清空，但是如果一个应用长时间不重启，那GC日志会增加，所以添加这3个参数，是GC日志滚动写入文件，但是如果重启，可能名字会出现混乱</td>
</tr>
<tr>
<td>-XX:PrintFLSStatistics=1</td>
<td>打印每次GC前后内存碎片的统计信息</td>
</tr>
</tbody></table>
<h3 id="收集器"><a href="#收集器" class="headerlink" title="收集器"></a>收集器</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明1</th>
<th>说明2</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>设置<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html#concurrent_mark_sweep_cms_collector">CMS收集器</a> （只针对老年代）</td>
<td>并发收集、低停顿；对CPU资源敏感，CMS默认启动的回收线程数是（CPU数量+3）/4；</td>
</tr>
<tr>
<td>-XX:+UseParNewGC</td>
<td>设置年轻代为多线程收集</td>
<td>可以不设置，jdk 8中设置-XX:+UseConcMarkSweepGC，自动启用-XX:+UseParNewGC</td>
</tr>
<tr>
<td>-XX:+CMSClassUnloadingEnabled</td>
<td>配合-XX:+UseConcMarkSweepGC使用，垃圾回收会清理持久代，移除不再使用的classes</td>
<td></td>
</tr>
<tr>
<td>-XX:+ UseG1GC</td>
<td>允许使用垃圾优先（G1）垃圾收集器。它是一个服务器式垃圾收集器，针对具有大量RAM的多处理器计算机。它以高概率满足GC暂停时间目标，同时保持良好的吞吐量。</td>
<td>G1收集器推荐用于需要大堆（大小约为6 GB或更大）且GC延迟要求有限的应用（稳定且可预测的暂停时间低于0.5秒）。</td>
</tr>
<tr>
<td>G1其他参数详情请见参考一</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="其他参数设置"><a href="#其他参数设置" class="headerlink" title="其他参数设置"></a>其他参数设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td>-ea</td>
<td align="left">启用断言，这个没有什么好说的，可以选择启用，或这选择不启用，没有什么大的差异。完全根据自己的系统进行处理</td>
</tr>
<tr>
<td>-XX:+UseThreadPriorities</td>
<td align="left">启用线程优先级，主要是因为我们可以给予周期性任务更低的优先级，以避免干扰客户端工作。在我当前的环境中，是默认启用的</td>
</tr>
<tr>
<td>-XX:ThreadPriorityPolicy=42</td>
<td align="left">允许降低线程优先级</td>
</tr>
<tr>
<td>-XX:+HeapDumpOnOutOfMemoryError</td>
<td align="left">发生内存溢出是进行heap-dump</td>
</tr>
<tr>
<td>-XX:HeapDumpPath=/path/to/java_pid.hprof</td>
<td align="left">这个参数与-XX:+HeapDumpOnOutOfMemoryError共同作用，设置heap-dump时内容输出文件</td>
</tr>
<tr>
<td>-XX:ErrorFile=/path/to/hs_err_pid.log</td>
<td align="left">指定致命错误日志位置。一般在JVM发生致命错误时会输出类似hs_err_pid.log的文件，默认是在工作目录中（如果没有权限，会尝试在/tmp中创建），不过还是自己指定位置更好一些，便于收集和查找，避免丢失</td>
</tr>
<tr>
<td>-XX:StringTableSize=1000003</td>
<td align="left">指定字符串常量池大小，默认值是60013。对Java稍微有点常识的应该知道，字符串是常量，创建之后就不可修改了，这些常量所在的地方叫做字符串常量池。如果自己系统中有很多字符串的操作，且这些字符串值比较固定，在允许的情况下，可以适当调大一些池子大小</td>
</tr>
<tr>
<td>-XX:+AlwaysPreTouch</td>
<td align="left">在启动时把所有参数定义的内存全部捋一遍。使用这个参数可能会使启动变慢，但是在后面内存使用过程中会更快。可以保证内存页面连续分配，新生代晋升时不会因为申请内存页面使GC停顿加长。通常只有在内存大于32G的时候才会有感觉</td>
</tr>
<tr>
<td>-XX:-UseBiasedLocking</td>
<td align="left">禁用偏向锁（在存在大量锁对象的创建且高度并发的环境下(即非多线程高并发应用)禁用偏向锁能够带来一定的性能优化）</td>
</tr>
<tr>
<td>-XX:AutoBoxCacheMax=20000</td>
<td align="left">增加数字对象自动装箱的范围，JDK默认-128～127的int和long，超出范围就会即时创建对象，所以，增加范围可以提高性能，但是也是需要测试</td>
</tr>
<tr>
<td>-XX:-OmitStackTraceInFastThrow</td>
<td align="left">不忽略重复异常的栈，这是JDK的优化，大量重复的JDK异常不再打印其StackTrace。但是如果系统是长时间不重启的系统，在同一个地方跑了N多次异常，结果就被JDK忽略了，那岂不是查看日志的时候就看不到具体的StackTrace，那还怎么调试，所以还是关了的好</td>
</tr>
<tr>
<td>-XX:+PerfDisableSharedMem</td>
<td align="left">启用标准内存使用。JVM控制分为标准或共享内存，区别在于一个是在JVM内存中，一个是生成/tmp/hsperfdata_{userid}/{pid}文件，存储统计数据，通过mmap映射到内存中，别的进程可以通过文件访问内容。通过这个参数，可以禁止JVM写在文件中写统计数据，代价就是jps、jstat这些命令用不了了，只能通过jmx获取数据。但是在问题排查是，jps、jstat这些小工具是很好用的，比jmx这种很重的东西好用很多，所以需要自己取舍。这里有个GC停顿的例子</td>
</tr>
<tr>
<td>-Djava.net.preferIPv4Stack=true</td>
<td align="left">这个参数是属于网络问题的一个参数，可以根据需要设置。在某些开启ipv6的机器中，通过InetAddress.getLocalHost().getHostName()可以获取完整的机器名，但是在ipv4的机器中，可能通过这个方法获取的机器名不完整，可以通过这个参数来获取完整机器名</td>
</tr>
</tbody></table>
<h2 id="JVM如何调优"><a href="#JVM如何调优" class="headerlink" title="JVM如何调优"></a>JVM如何调优</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>​    第1步：分析GC日志（详见参考四、五）及dump文件，判断是否需要优化，确定瓶颈问题点；</p>
<p>​    第2步：确定JVM调优量化目标；</p>
<p>​    第3步：确定JVM调优参数（根据历史JVM参数来调整）；</p>
<p>​    第4步：调优一台服务器，对比观察调优前后的差异；</p>
<p>​    第5步：不断的分析和调整，直到找到合适的JVM参数配置；</p>
<p>​    第6步：找到最合适的参数，将这些参数应用到所有服务器，并进行后续跟踪。</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p>jps：查询java进程</p>
<p>jstat：虚拟机运行状态信息</p>
<p>jmap：生成堆存储快照</p>
<p>jstack：生成虚拟机当前时刻的线程快照，帮助定位线程出现长时间停顿的原因</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c6a04c88900a">https://www.jianshu.com/p/c6a04c88900a</a></p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>不同的环境有不同的方案，可以参考，不过还是建议在自己的环境中有针对的验证之后再使用，毕竟各自的环境都有差异。</p>
<h3 id="gc查看"><a href="#gc查看" class="headerlink" title="gc查看"></a>gc查看</h3><p>查看gc.log状态，可参考 <font color="red">参考四、参考五</font>；</p>
<p>结论：没有Full GC；每次从年轻代移到了老年代的内存占老年代总内存比例并不大：</p>
<p><img src="https://pic.downk.cc/item/5f223ba014195aa594eca7aa.png"></p>
<p>查看star.hprof文件（使用JProfiler），如果有的话；</p>
<p>查询某一时刻虚拟机运行状态；</p>
<p>./jdk/jdk1.8.0_101/bin/jstat -gc 【pid】 3600s</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>设置的值</th>
</tr>
</thead>
<tbody><tr>
<td>S0C</td>
<td>Survivor0空间的大小。单位KB。</td>
<td>316992.0（0.3G）</td>
</tr>
<tr>
<td>S1C</td>
<td>Survivor1空间的大小。单位KB。</td>
<td>316992.0（0.3G）</td>
</tr>
<tr>
<td>S0U</td>
<td>Survivor0已用空间的大小。单位KB。</td>
<td>0</td>
</tr>
<tr>
<td>S1U</td>
<td>Survivor1已用空间的大小。单位KB。</td>
<td>17521.7</td>
</tr>
<tr>
<td>EC</td>
<td>Eden空间的大小。单位KB。</td>
<td>2536320.0（2.4G）</td>
</tr>
<tr>
<td>EU</td>
<td>Eden已用空间的大小。单位KB。</td>
<td></td>
</tr>
<tr>
<td>OC</td>
<td>老年代空间的大小。单位KB。</td>
<td>3121152.0（3G）</td>
</tr>
<tr>
<td>OU</td>
<td>老年代已用空间的大小。单位KB。</td>
<td>221391（0.21G）</td>
</tr>
<tr>
<td>MC</td>
<td>方法区大小</td>
<td>125824.0（0.12G）</td>
</tr>
<tr>
<td>MU</td>
<td>方法区使用大小</td>
<td>119041（0.11G）</td>
</tr>
<tr>
<td>CCSC</td>
<td>压缩类空间大小</td>
<td>13824.0（0.01G）</td>
</tr>
<tr>
<td>CCSU</td>
<td>压缩类空间使用大小</td>
<td>12536</td>
</tr>
<tr>
<td>YGC</td>
<td>年轻代垃圾回收次数</td>
<td>261</td>
</tr>
<tr>
<td>YGCT</td>
<td>年轻代垃圾回收消耗时间</td>
<td>10.931（0.04s/次）</td>
</tr>
<tr>
<td>FGC</td>
<td>老年代垃圾回收次数</td>
<td>0</td>
</tr>
<tr>
<td>FGCT</td>
<td>老年代垃圾回收消耗时间</td>
<td>0</td>
</tr>
<tr>
<td>GCT</td>
<td>垃圾回收消耗总时间</td>
<td>10.931</td>
</tr>
</tbody></table>
<h4 id="查看系统jvm参数状态"><a href="#查看系统jvm参数状态" class="headerlink" title="查看系统jvm参数状态"></a>查看系统jvm参数状态</h4><p>机器状况</p>
<table>
<thead>
<tr>
<th>内存</th>
<th>CPU</th>
<th>磁盘空间</th>
</tr>
</thead>
<tbody><tr>
<td>8G</td>
<td>4*4</td>
<td>60G</td>
</tr>
</tbody></table>
<p>当前jvm参数配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms6144m -Xmx6144m -XX:MaxPermSize&#x3D;256m -verbose:gc -XX:+PrintGCDetails -Xloggc:&#x2F;..&#x2F;tomcat&#x2F;logs&#x2F;gc.log -XX:+PrintGCTimeStamps -XX:+PrintGCDetails -XX:MetaspaceSize&#x3D;256m -XX:MaxMetaspaceSize&#x3D;256m -Xmn3096m -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSClassUnloadingEnabled -XX:+ExplicitGCInvokesConcurrent -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath&#x3D;&#x2F;..&#x2F;tomcat&#x2F;logs&#x2F;star.hprof </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">参数</td>
<td align="left">说明</td>
<td align="left">建议</td>
</tr>
<tr>
<td align="left">-Xms6144m</td>
<td align="left">初始化堆内存大小为6GB</td>
<td align="left">低于系统内存</td>
</tr>
<tr>
<td align="left">-Xmx6144m</td>
<td align="left">堆内存最大值为6GB</td>
<td align="left">低于系统内存</td>
</tr>
<tr>
<td align="left"><del>-XX:MaxPermSize=256m</del></td>
<td align="left">设置永久代最大为256MB（无用）</td>
<td align="left">jdk1.8不需要设置</td>
</tr>
<tr>
<td align="left">-verbose:gc</td>
<td align="left">输出虚拟机中GC的详细情况</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+PrintGCDetails</td>
<td align="left">输出虚拟机中GC的详细情况</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-Xloggc:/../tomcat/logs/gc.log</td>
<td align="left">设置gc日志文件位子</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+PrintGCTimeStamps</td>
<td align="left">打印gc时间时间戳，gc.log</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:MetaspaceSize=256m</td>
<td align="left">设置元数据区初始值256M （永久代）</td>
<td align="left">该值越大触发Full GC的时机就越晚，</td>
</tr>
<tr>
<td align="left">-XX:MaxMetaspaceSize=256m</td>
<td align="left">设置元数据区最大值256M （永久代）</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-Xmn3096m</td>
<td align="left">设置年轻代区域3G</td>
<td align="left">Sun官方推荐配置为整个堆的3/8</td>
</tr>
<tr>
<td align="left">-XX:+UseConcMarkSweepGC</td>
<td align="left">设置<font color="red"><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html#concurrent_mark_sweep_cms_collector">CMS收集器</a> （只针对老年代）</font></td>
<td align="left">并发收集、低停顿；对CPU资源敏感，CMS默认启动的回收线程数是（CPU数量+3）/4；</td>
</tr>
<tr>
<td align="left"><del>-XX:+UseParNewGC</del></td>
<td align="left">设置<font color="red">年轻代为多线程收集</font></td>
<td align="left">可以不设置，jdk 8中设置-XX:+UseConcMarkSweepGC，自动启用-XX:+UseParNewGC</td>
</tr>
<tr>
<td align="left">-XX:+CMSClassUnloadingEnabled</td>
<td align="left">配合-XX:+UseConcMarkSweepGC使用，垃圾回收会清理持久代，移除不再使用的classes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+ExplicitGCInvokesConcurrent</td>
<td align="left">允许使用<code>System.gc()</code>请求调用并发GC 。默认情况下禁用此选项，并且只能与该<code>-XX:+UseConcMarkSweepGC</code>选项一起启用</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses</td>
<td align="left">通过<code>System.gc()</code>在并发GC周期期间使用请求和卸载类，可以调用并发GC。默认情况下禁用此选项，并且只能与该<code>-XX:+UseConcMarkSweepGC</code>选项一起启用</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+HeapDumpOnOutOfMemoryError</td>
<td align="left">通过使用堆分析器（HPROF）将Java堆转储到当前目录中的文件</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:HeapDumpPath=/home/ewallet/loan-star/loan-star-pre/default/tomcat/logs/star.hprof</td>
<td align="left">设置用于写入堆分析器（HPROF）提供的堆转储的路径和文件名。默认情况下，该文件在当前工作目录中创建，并且名为java_pidpid.hprof，其中pid是导致错误的进程的标识符</td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>当前机器的配置足够，在目前情况下优化参数不会有太大的提升效果。</p>
<p>假如在降低机器配置前提下，那需要依赖数据，做相应的调整，具体要看机器成本而定。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h4 id="附一-找到占用cpu最高的一个线程"><a href="#附一-找到占用cpu最高的一个线程" class="headerlink" title="附一 找到占用cpu最高的一个线程"></a>附一 找到占用cpu最高的一个线程</h4><ul>
<li><p>第一步，找到占用cpu最高的一个线程pid</p>
<p>方法：直接top,然后shift+h</p>
</li>
<li><p>第二步，将其转化成16进制。假使我们得到的线程号为【n】，接下来将它转成16进制，记为spid</p>
<p>方法：printf 0x%x 【n】</p>
</li>
<li><p>第三步，执行jstack -l 【pid】| grep 【spid】 -A 100 打印后面100行分析问题</p>
<p>插件使用：<a target="_blank" rel="noopener" href="https://github.com/oldratlee/useful-scripts">https://github.com/oldratlee/useful-scripts</a></p>
</li>
</ul>
<h4 id="附二-参考资料"><a href="#附二-参考资料" class="headerlink" title="附二 参考资料"></a>附二 参考资料</h4><p>参考一：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html </a>（ <font color="red">参数</font>）</p>
<p>​       <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html%EF%BC%88">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html（</a><font color="red">收集器</font>）</p>
<p>​       <a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/tuning-139912.html%EF%BC%88">https://www.oracle.com/technetwork/java/tuning-139912.html（</a><font color="red">调优试例</font>）</p>
<p>参考二：书籍：深入理解Java虚拟机（第二版） </p>
<p>​       书籍：Java Performance：The Definitive Guide</p>
<p> 参考三：<a target="_blank" rel="noopener" href="https://blog.csdn.net/linhu007/article/details/48897597%EF%BC%88">https://blog.csdn.net/linhu007/article/details/48897597（</a><font color="red">CMS与G1</font>）</p>
<p>参考四：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zc19921215/article/details/83029952">https://blog.csdn.net/zc19921215/article/details/83029952</a></p>
<p>参考五：<a target="_blank" rel="noopener" href="https://www.aliyun.com/jiaocheng/1341282.html">https://www.aliyun.com/jiaocheng/1341282.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chen Jianfeng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>


  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"1kVszHAOMaqpz0p9HaUY4jS3-9Nh9j0Va","appKey":"GKfDomM0s9bBI7BLr9K1iSvR","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"language":"zh-cn","visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
