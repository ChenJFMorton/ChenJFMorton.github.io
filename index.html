<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"8.0.0-rc.4","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Chenjf&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Chenjf&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chen Jianfeng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Chenjf's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Chenjf's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chen Jianfeng"
      src="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
  <p class="site-author-name" itemprop="name">Chen Jianfeng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/20/20211220-guildfi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/20/20211220-guildfi/" class="post-title-link" itemprop="url">链游平台GuildFi调研分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-20 11:18:43" itemprop="dateCreated datePublished" datetime="2021-12-20T11:18:43+08:00">2021-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-25 14:04:45" itemprop="dateModified" datetime="2022-01-25T14:04:45+08:00">2022-01-25</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/12/20/20211220-guildfi/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/12/20/20211220-guildfi/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今年链游的数量和玩家人数都有了大规模的增长，<br>来自DappRadar的一份<a target="_blank" rel="noopener" href="https://dappradar.com/blog/bga-blockchain-game-report-october-2021">报告</a>显示，<br>10月份平均每天有超过100万个独立的活跃钱包地址连接到链游app中，<br>而资本市场当月更有1.2亿美金投入链游相关的平台项目中。</p>
<p><img src="/image/guildfi/guildfi-15.png"></p>
<p>一方是玩家大量的涌入链游，另一方则是链游项目在资本的助推下不断涌现。</p>
<p>这时候连接的价值日益显现：<br>比如YGG等公会的出现，连接了游戏和玩家两方，<br>通过游戏道具的租借和专业的培训，<br>使玩家进场成本更低收益更高，也使游戏方获得了更多的用户。<br>而当游戏越来越多，单一公会其实无法带领玩家触达每一个链游，<br>各类公会就出现分而治之的局面，各自招募玩家奔向不同的链游。</p>
<p>这时候，就出现了一种平台的机会，<br>能够连接所有的玩家，链游和不同的游戏公会，<br>给它们一个互相发现、互相匹配并获取收益的渠道。<br>今天我们要讲的<a target="_blank" rel="noopener" href="https://guildfi.com/">GuildFi</a>就是这样一个平台，<br>专注于与玩家、游戏和公会之间的连接。</p>
<p><img src="/image/guildfi/guildfi.png"></p>
<h2 id="GuildFi是什么"><a href="#GuildFi是什么" class="headerlink" title="GuildFi是什么"></a>GuildFi是什么</h2><h3 id="弥补链游市场需求和现实的差距"><a href="#弥补链游市场需求和现实的差距" class="headerlink" title="弥补链游市场需求和现实的差距"></a>弥补链游市场需求和现实的差距</h3><p>在介绍GuildFi之前，我们不妨先看看目前链游市场上的参与者和他们的需求。</p>
<ol>
<li>玩家：需要低成本的寻找+进入更多收益高的游戏，并把游戏中投入的时间价值最大化；</li>
<li>游戏：需要低成本且广泛的吸引玩家参与；</li>
<li>公会：需要快速创建公会并招募玩家参与，并需要找到更多值得入驻的游戏。</li>
</ol>
<p><img src="/image/guildfi/guildfi-1.jpg"></p>
<p>而在目前的链游市场中，现实情况并不能完全满足他们的需求：</p>
<ol>
<li>玩家：零散的寻找要进入的游戏，支付高额进场费用，研究打金攻略，投入产出比不稳定；</li>
<li>游戏：多渠道通过广告、运营活动和社交媒体进行营销和获客，存在投放宣传成本；</li>
<li>公会：各自创建公会并找寻玩家，创建公会需要大量启动资金，且寻找玩家成本高</li>
</ol>
<p><img src="/image/guildfi/guildfi-3.jpg"></p>
<p><strong>可以明显的看出，三类角色的需求和现实情况仍存在着差距</strong>，<br>因此目前的链游市场其实可以构建一个平台来连接玩家、游戏和公会，<br>并解决他们在现实情况中遇到的问题。</p>
<h3 id="GuildFi-连接链游市场各参与方的多功能服务平台"><a href="#GuildFi-连接链游市场各参与方的多功能服务平台" class="headerlink" title="GuildFi: 连接链游市场各参与方的多功能服务平台"></a>GuildFi: 连接链游市场各参与方的多功能服务平台</h3><p>GuildFi的目标是努力缩小现在链游市场上各参与者的需求和现实差距，<br>其实现手段则是为玩家、游戏和公会提供各自急缺的服务，<br>并作为一个平台将服务资源在三者之间共享，以达到相互发现，提升效率的目的。<br>总体来看，<strong>GuildFi提供了四大服务：游戏平台、公会专区、NFT专区、工具专区</strong>，</p>
<p><img src="/image/guildfi/guildfi-overview.jpg"></p>
<p>每一个服务中又细分成了不同的功能模块。<br>考虑到GuildFi中的模块较多，单纯的介绍功能未必能完全理解它的设计用意，<br>我们仍然接着上面玩家、游戏和公会各自遇到的问题来讲解GuildFi的功能设计，<br>看看它是如何对症下药来解决问题的。</p>
<p><strong>1.玩家：通过「发现游戏」和「发现公会」功能，降低游戏寻找成本和进场成本</strong><br>在GuildFi的游戏平台功能中，有2个叫做发现「游戏发现」和「发现公会」的功能。<br>在游戏发现方面：<br>即平台会列出目前值得参与的游戏列表，<br>并提供该游戏的基础信息和相关的数据分析。<br>对于数据分析功能，目前官网显示功能即将上线，<br>但我们可以猜测，这类分析一定与游戏活跃用户数、投入产出比等信息相关，<br>借此来为玩家提供是否参与游戏的判断依据。</p>
<p>在游戏方面，官网上目前支持的游戏仅有2款，分别是Cyball和Axie，<br>而在官方的白皮书中我们则看到了另外两款引人关注的作品也将整合进入GuildFi：<br>Sandbox和Star Atlas。</p>
<p><img src="/image/guildfi/guildfi-8.png"></p>
<p>这几款游戏的号召力不必多提，前期选入游戏发现列表中也是GuildFi吸引用户的举措，<br>但能够争取到这几款游戏加入，足见GuildFi在链游领域的资源。</p>
<p>对于另外一个名为「公会发现」的功能，其实不难理解，<br>当链游市场上有很多公会时，玩家可能不知道加入其中的哪一个，<br>而GuildFi也提供了公会列表，并列出了不同公会的所在区域和与用户分成的比例。</p>
<p><img src="/image/guildfi/guildfi-guild-discovery.png"></p>
<p>此外最重要的是，公会往往会提供“奖学金”计划，<br>通过租赁游戏进场所需的NFT，降低玩家进入游戏的成本，<br>并提供专业的辅导和教学来告诉玩家如何提高打金水平和收益。<br>这些信息若都能集成在GuildFi中，将极大程度的降低玩家的学习成本和进场成本，<br>这就解决了前文所述的玩家在现实中面临的问题。</p>
<p><img src="/image/guildfi/guildfi-4.jpg"></p>
<p><strong>2.玩家：通过一站式账号ID和经验值系统，最大化玩家的时间价值</strong><br>在游戏平台中还存在两个功能分别是GuildFi ID和“游玩证明”，<br>前者是该平台的通用ID，仅需简单的注册步骤，<br>即可达到“一个账号，畅玩平台全部游戏”的效果，而不同游戏的时长，成就等也都集成在账号中，<br>这非常类似苹果商店或者谷歌商店的账号，能够管理手机内所有下载游戏的信息。</p>
<p>而与ID关联的则是任务和奖励系统，平台会自动关联你玩的所有游戏，<br>并设计一系列的任务让你达成，成功后可以获得GXP（GuildFi的游戏经验值系统），<br>这些奖励可以让你获得额外的NFT空投，新游戏提前体验以及GF通证。</p>
<p><img src="/image/guildfi/guildfi-9.png"></p>
<p>这种统一账户ID和游戏经验值奖励的设计，则最大化了玩家投入时间的价值，<br>而以前玩家玩不同的游戏仅能获得游戏内的奖励，<br>现在则多了一层GuildFi平台提供的奖励，一举多得。</p>
<p><img src="/image/guildfi/guildfi-5.jpg"></p>
<p><strong>3.公会：提供公会网络+一站式公会组建服务，降低公会组建和运营成本</strong><br>GuildFi作为一个平台，自然会有自己的基金和天使投资，<br>通过背后资金的支持，初始创建的公会可以向平台借入NFT资产，<br>而公会则可以将这些资产再借出给招募的玩家，这就降低了公会的资金成本。</p>
<p>此外，如果多个公会都入驻了GuildFi平台，他们之间也可以互相出借NFT资产，<br>这也达到了公会间资源的优化配置。<br>在招募玩家方面，GuildFi也内置了一个“奖学金门户”，<br>使公会能够更为快捷的通过平台招募到玩家，这也对应着前文介绍的面向玩家的“公会发现”，<br>达到了玩家和公会之间匹配效率的提升。</p>
<p><img src="/image/guildfi/guildfi-10.png"></p>
<p>更为重要的是，GuildFi平台推出了一项“公会即服务”的功能，<br>这个概念与时下流行的“云服务”和“软件即服务”的概念类似，<br>即由GuildFi提供各种公会所需要的模块，如创建ID、注资、运营、资产管理等，<br>公会进来可以按照自己目前发展的阶段，按需选取相应的模块和服务，从而完善自己的公会建设。<br>而以上这些则解决了公会目前在链游领域面临的种种问题。</p>
<p><img src="/image/guildfi/guildfi-6.jpg"></p>
<p><strong>4.游戏：Metadrop作为营销手段吸引更多用户参与</strong><br>对于玩家来说，吸引他们参与某个游戏的理由，<br>除了打金收益外，不定时的NFT和通证空投也是其中之一。<br>对玩家来说的“薅羊毛”，其实对游戏方来说则是一种重要的获客手段。</p>
<p><img src="/image/guildfi/guildfi-11.png"></p>
<p>GuildFi平台也提供了一个Metadrop专区，专供游戏方来发布空投，<br>而玩家则依据前文所述的GXP等来获得不同层级的空投奖励，<br>此举也更好的连接了玩家和游戏方，而这种直接的激励都可以在同一个平台上完成，<br>在平台粘性增加的同时，接入平台的游戏方均可受益。</p>
<p><img src="/image/guildfi/guildfi-7.jpg"></p>
<p>最后，游戏的工具专区在官网中并没有得到体现，<br>白皮书中描述该区域主要是用于公会奖学金的账户管理和支付管理，<br>同时还能看到不同游戏的排行榜以及PVP模拟等，<br>这一部分内容是GuildFi基于Axie的公会经验所开发的，<br>实际成品功能的普适性有待后续观察。</p>
<h3 id="GuildFi的基本面：优秀资方加持-丰富的公会经验"><a href="#GuildFi的基本面：优秀资方加持-丰富的公会经验" class="headerlink" title="GuildFi的基本面：优秀资方加持+丰富的公会经验"></a>GuildFi的基本面：优秀资方加持+丰富的公会经验</h3><p>GuildFi已经完成了600万美元的种子轮融资，<br>除了Definance和hashed领投之外，<br>Aniomca，coinbase及coin98等也参与了投资，<br>这些知名的资方入局，也体现了资本对于构建GuildFi平台的看好，<br>毕竟目前市场上公会众多，而连接公会游戏和玩家的平台则没有出现龙头。</p>
<p><img src="/image/guildfi/guildfi-12.png"></p>
<p>而关于GuildFi，其前身也是一个泰国本地的游戏公会，<br>成立社区超过5年，并活跃在Axie、THG和传奇4等游戏中，<br>举办过不少公会活动，如举办杯赛和组织团队击杀游戏BOSS等。</p>
<p><img src="/image/guildfi/guildfi-13.png"></p>
<p>这些公会经验在建立GuildFi平台时可以得到复用，并指导其他公会的创建和运营。</p>
<h2 id="GF通证介绍"><a href="#GF通证介绍" class="headerlink" title="GF通证介绍"></a>GF通证介绍</h2><p>在了解完GuildFi的全部功能后，其通证GF的作用就变得非常易于理解，<br>随着GuildFi的功能落地和发展，GF对GuildFi的功能存在价值捕获的效应:</p>
<ol>
<li>价值发现：GuildFi里的游戏玩家越多，游戏生态越庞大，则意味着平台收入的提高和流量的增加，这将对GF通证形成利好。</li>
<li>GF DAO会员权益：持有GF，玩家可以抢先体验游戏，参与稀有NFT分配和空投，并获得质押奖励。此外，GuildFi为公会提供的各种创建服务也会产生收益，玩家可以依据持有的GF比例获得不同额度的分成。</li>
<li>治理与决策：投票哪些游戏可以加入GuildFi等。</li>
</ol>
<p>值得一提的是，GF目前正在官方进行通证拍卖。</p>
<p>起始时间为12月1日-12月4日，并采用价高者得的荷兰拍卖形式， 有兴趣的读者可以关注。</p>
<p><img src="/image/guildfi/guildfi-14.png"></p>
<h2 id="GuildFi的潜力和风险"><a href="#GuildFi的潜力和风险" class="headerlink" title="GuildFi的潜力和风险"></a>GuildFi的潜力和风险</h2><p>综合来看，GuildFi目前在做的是典型的平台建设，<br>即通过平台来匹配市场上的供需方，实现资源最优配置。</p>
<p>这种做法类似于滴滴打车平台， 通过吸引打车人和车主入驻，且无论车辆属于哪家服务公司， 都能满足运输能力和出行需求的高效匹配。</p>
<p><strong>这里的打车人=玩家，这辆车=游戏， 车主或者服务公司=公会，而滴滴=GuildFi</strong>。</p>
<p>而平台经济往往具备两个优势， 即“赢家通吃”和“先发制人”，</p>
<p>一旦用户粘性构建起来后， 其他想要效仿该平台则难以获得同级别的流量。</p>
<p>也正因为GuildFi在做连接玩家、游戏和公会间的平台，</p>
<p>它的定位和我们熟知的YGG也是不一样的，</p>
<p><strong>GuildFi可以被理解为： YGG + 公会搭建支持 + 公会资源贡献 + 平台经济</strong>。</p>
<p>但我们也应该清楚的认识到，<br>做一个连接的平台也不存在技术壁垒，<br>其他的公会也可以争相模仿，如果竞对拥有更快的建设速度和更加雄厚的资本支持，<br>那么GuildFi的优势也有可能被瓦解。</p>
<p>此外，一些优质的链游出于利益的考虑可能也不会选择和平台合作，<br>类似著名手游元神不和发行渠道合作，独自负责宣发而避免高额的抽成，<br>这时候GuildFi的连接游戏方的作用也会受到影响。</p>
<p>而无论如何，一个完整的元宇宙概念里，<br>游戏，玩家和公会应该是可以高效的相互链接的，<br>在目前元宇宙中的角色们还处在一个个孤岛中的情况下，<br>构建连接是完全值得提倡的。<br>虽然连接不同角色的道路比较难走，<br>涉及到各类资源的整合，<br>但最曲折的路有时最简捷，<br>这条路可能也是通向元宇宙繁荣的捷径。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/09/20211209-protobufUseInGame/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/09/20211209-protobufUseInGame/" class="post-title-link" itemprop="url">浏览器使用websocket通过protobuf协议与netty服务端通信</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-09 10:39:30" itemprop="dateCreated datePublished" datetime="2021-12-09T10:39:30+08:00">2021-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-14 15:34:56" itemprop="dateModified" datetime="2021-12-14T15:34:56+08:00">2021-12-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/12/09/20211209-protobufUseInGame/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/12/09/20211209-protobufUseInGame/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>本文主要介绍如何通过浏览器WEB使用websocket、protobuf协议与netty服务端通信。<br>主要涉及到的技术点：js、websocket、java、netty、protobuf，下面会详细介绍如何使用。</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>主要涉及到四个文件，看截图，完成这些，客户端这边就OK了。<br><img src="/image/protoClientDemo.png"></p>
<h3 id="ptoto文件"><a href="#ptoto文件" class="headerlink" title="ptoto文件"></a>ptoto文件</h3><ol>
<li>SubscribeReq.proto，用于发送到服务端：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syntax=&quot;proto3&quot;;</span><br><span class="line">package req;</span><br><span class="line"></span><br><span class="line">message SubscribeReq &#123;</span><br><span class="line">  int32 subReqId = 1;</span><br><span class="line">  string userName = 2;</span><br><span class="line">  string productName = 3;</span><br><span class="line">  string address = 4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>SubscribeResp.proto，用于解析服务端发送过来的消息：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax=&quot;proto3&quot;;</span><br><span class="line">package res;</span><br><span class="line"></span><br><span class="line">message SubscribeResp&#123;</span><br><span class="line">  int32 subReqId = 1;</span><br><span class="line">  int32 respCode = 2;</span><br><span class="line">  string desc = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
注：package对应客户端中的代码root.lookupType(className)，className:#{package}.#{message}</li>
</ol>
<h3 id="protobuf-min-js"><a href="#protobuf-min-js" class="headerlink" title="protobuf.min.js"></a>protobuf.min.js</h3><p><a target="_blank" rel="noopener" href="https://github.com/protobufjs/protobuf.js/releases">protobuf.min.js</a>下载地址</p>
<ol>
<li>下载<br>选择最近版本zip下载</li>
<li>解压，获取目标文件<br>protobuf.min.js文件在解压后dist目录下，如图：<br><img src="/image/protoJsFile.png"></li>
<li>放到html同级目录，并在html中引用</li>
</ol>
<h3 id="html客户端"><a href="#html客户端" class="headerlink" title="html客户端"></a>html客户端</h3><p>TestProtobuf.html：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;script src=&quot;protobuf.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;button onclick=&quot;sendMsg()&quot;&gt;手动发送&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    let buffer;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 手动发送消息</span><br><span class="line">     */</span><br><span class="line">    function sendMsg()&#123;</span><br><span class="line">        let payload = &#123;subReqId: 1, userName: &quot;cjf&quot;, productName: &quot;hello server 我是客户端   111 !!&quot;, address:&quot;地址&quot;&#125;;</span><br><span class="line">        let message = reqMessage.create(payload); // or use .fromObject if conversion is necessary</span><br><span class="line">        buffer = reqMessage.encode(message).finish();</span><br><span class="line">        webSocket.send(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    // 客户端请求对象</span><br><span class="line">    let reqMessage;</span><br><span class="line">    // 服务端返回对象</span><br><span class="line">    let resMessage;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 初始化 reqMessage</span><br><span class="line">     * @param fileName</span><br><span class="line">     * @param className</span><br><span class="line">     * @param type 1:request,2:response</span><br><span class="line">     */</span><br><span class="line">    function initCusMsg(fileName, className, type) &#123;</span><br><span class="line"></span><br><span class="line">        return protobuf.load(fileName)</span><br><span class="line">            .then((root) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                if (type === 1) &#123;</span><br><span class="line">                    reqMessage = root.lookupType(className);</span><br><span class="line">                    return reqMessage;</span><br><span class="line">                &#125; else if (type === 2) &#123;</span><br><span class="line">                    resMessage = root.lookupType(className);</span><br><span class="line">                    return resMessage;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const address = &quot;ws://127.0.0.1:9999/ws&quot;;</span><br><span class="line"></span><br><span class="line">    let webSocket = new WebSocket(address);</span><br><span class="line"></span><br><span class="line">    webSocket.onopen = function () &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        console.log(&quot;webSocket连接建立成功... &quot; + &quot;服务端address: &quot; + address);</span><br><span class="line">        //连接成功 发送消息</span><br><span class="line"></span><br><span class="line">        let reqMsgPromise = initCusMsg(&quot;SubscribeReq.proto&quot;, &quot;req.SubscribeReq&quot;, 1);</span><br><span class="line"></span><br><span class="line">        reqMsgPromise.then((cusMsg) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">            //参考 https://github.com/protobufjs/protobuf.js#using-proto-files</span><br><span class="line"></span><br><span class="line">            // Exemplary payload</span><br><span class="line">            let cuTime = new Date().getTime();</span><br><span class="line">            let payload = &#123;</span><br><span class="line">                subReqId: 1, userName: &quot;cjf&quot;, productName: &quot;hello server 我是客户端 2222!!&quot;, address:&quot;地址&quot;&#125;;</span><br><span class="line">            // Verify the payload if necessary (i.e. when possibly incomplete or invalid)</span><br><span class="line">            let errMsg = cusMsg.verify(payload);</span><br><span class="line">            if (errMsg) &#123;</span><br><span class="line"></span><br><span class="line">                throw Error(errMsg);</span><br><span class="line">            &#125;</span><br><span class="line">            // Create a new message</span><br><span class="line">            let message = cusMsg.create(payload); // or use .fromObject if conversion is necessary</span><br><span class="line">            // Encode a message to an Uint8Array (browser) or Buffer (node)</span><br><span class="line">            buffer = cusMsg.encode(message).finish();</span><br><span class="line"></span><br><span class="line">            webSocket.send(buffer);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    //接收消息</span><br><span class="line">    let reader = new FileReader();</span><br><span class="line">    //监听服务端响应消息</span><br><span class="line">    webSocket.onmessage = function (event) &#123;</span><br><span class="line">        let resMsgPromise = initCusMsg(&quot;SubscribeResp.proto&quot;, &quot;res.SubscribeResp&quot;, 2);</span><br><span class="line"></span><br><span class="line">        resMsgPromise.then((cusMsg) =&gt; &#123;</span><br><span class="line">            reader.readAsArrayBuffer(event.data);</span><br><span class="line">            reader.onload = () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">                let arrayBuffer = reader.result;</span><br><span class="line">                let buffer = new Uint8Array(arrayBuffer);</span><br><span class="line"></span><br><span class="line">                let resObject = resMessage.decode(buffer);</span><br><span class="line">                let errMsg = cusMsg.verify(resObject);</span><br><span class="line">                if (errMsg) &#123;</span><br><span class="line"></span><br><span class="line">                    throw Error(errMsg);</span><br><span class="line">                &#125;</span><br><span class="line">                console.log(resObject)</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>主要涉及到几个文件，看截图，完成这些，服务端这边就OK了。<br><img src="/image/protoServerDemo.png"></p>
<h3 id="ptoto文件-1"><a href="#ptoto文件-1" class="headerlink" title="ptoto文件"></a>ptoto文件</h3><ol>
<li><p>SubscribeReq.proto：定义解析客户端发过来的数据格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax=&quot;proto3&quot;;</span><br><span class="line">option java_package = &quot;com.gate.protobuf&quot;;</span><br><span class="line">option java_outer_classname = &quot;SubscribeReqProto&quot;;</span><br><span class="line"></span><br><span class="line">message SubscribeReq &#123;</span><br><span class="line">  int32 subReqId = 1;</span><br><span class="line">  string userName = 2;</span><br><span class="line">  string productName = 3;</span><br><span class="line">  string address = 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>SubscribeResp.proto：定义发送到客户端的数据格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax=&quot;proto3&quot;;</span><br><span class="line">option java_package = &quot;com.gate.protobuf&quot;;</span><br><span class="line">option java_outer_classname=&quot;SubscribeRespProto&quot;;</span><br><span class="line"></span><br><span class="line">message SubscribeResp&#123;</span><br><span class="line">  required int32 subReqId = 1;</span><br><span class="line">  required int32 respCode = 2;</span><br><span class="line">  required string desc = 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases">protobuf-java-3.19.1.zip</a>，解压后可以配置下全局命令执行。</p>
</li>
<li><p>生成java文件<br>执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc --java_out=./ SubscribeReq.proto</span><br><span class="line">protoc --java_out=./ SubscribeResp.proto</span><br></pre></td></tr></table></figure>
<p>生成SubscribeReqProto.java、SubscribeRespProto.java</p>
</li>
</ol>
<p>注：java_package路径对应生成的java包路径， java_outer_classname对应生成的java文件名</p>
<h3 id="依赖包引用"><a href="#依赖包引用" class="headerlink" title="依赖包引用"></a>依赖包引用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.19.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注：protobuf-java的版本要对应protoc的版本</p>
<h3 id="netty服务端"><a href="#netty服务端" class="headerlink" title="netty服务端"></a>netty服务端</h3><p>Server.java代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class Server &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 自定义ChannelInitializer</span><br><span class="line">     */</span><br><span class="line">    public void start() &#123;</span><br><span class="line">        short port = 9999;</span><br><span class="line">        ServerBootstrap serverBootstrap = new ServerBootstrap();</span><br><span class="line">        NioEventLoopGroup boos = new NioEventLoopGroup();</span><br><span class="line">        NioEventLoopGroup worker = new NioEventLoopGroup();</span><br><span class="line">        serverBootstrap.group(boos, worker);</span><br><span class="line">        serverBootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">        serverBootstrap.childHandler(new CustomChannelInitializer());</span><br><span class="line">        try &#123;</span><br><span class="line">            Channel channel = serverBootstrap.bind(port).sync().channel();</span><br><span class="line">            System.out.println(&quot;服务端启动 端口:&quot; + port);</span><br><span class="line">            channel.closeFuture().await();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new Server().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomChannelInitializer.java代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class CustomChannelInitializer  extends ChannelInitializer&lt;SocketChannel&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void initChannel(SocketChannel socketChannel) &#123;</span><br><span class="line">        ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line"></span><br><span class="line">        pipeline.addLast(new HttpServerCodec());</span><br><span class="line">        pipeline.addLast(new ChunkedWriteHandler());</span><br><span class="line">        pipeline.addLast(new HttpObjectAggregator(1024 * 64));</span><br><span class="line"></span><br><span class="line">        pipeline.addLast(new WebSocketServerProtocolHandler(&quot;/ws&quot;));</span><br><span class="line"></span><br><span class="line">        //将WebSocketFrame转为ByteBuf 以便后面的 ProtobufDecoder 解码</span><br><span class="line">        pipeline.addLast(new MessageToMessageDecoder&lt;WebSocketFrame&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            protected void decode(ChannelHandlerContext ctx, WebSocketFrame frame, List&lt;Object&gt; out) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">                ByteBuf byteBuf = frame.content();</span><br><span class="line">                byteBuf.retain();</span><br><span class="line">                out.add(byteBuf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        pipeline.addLast(new ProtobufDecoder(SubscribeReqProto.SubscribeReq.getDefaultInstance()));</span><br><span class="line">        //自定义入站处理</span><br><span class="line">        pipeline.addLast(new TestProtoBufInboundHandler());</span><br><span class="line"></span><br><span class="line">        //出站处理 将protoBuf实例转为WebSocketFrame</span><br><span class="line">        pipeline.addLast(new ProtobufEncoder() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            protected void encode(ChannelHandlerContext ctx, MessageLiteOrBuilder msg, List&lt;Object&gt; out) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">                SubscribeRespProto.SubscribeResp mpMsg = (SubscribeRespProto.SubscribeResp) msg;</span><br><span class="line">                WebSocketFrame frame = new BinaryWebSocketFrame(Unpooled.wrappedBuffer(mpMsg.toByteArray()));</span><br><span class="line">                out.add(frame);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TestProtoBufInboundHandler.java代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class TestProtoBufInboundHandler extends SimpleChannelInboundHandler&lt;SubscribeReqProto.SubscribeReq&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void channelRead0(ChannelHandlerContext ctx, SubscribeReqProto.SubscribeReq msg) throws Exception &#123;</span><br><span class="line">        Gson gson = new Gson();</span><br><span class="line">        System.out.printf(&quot;服务端收到请求数据：%s&quot;, gson.toJson(msg));</span><br><span class="line"></span><br><span class="line">        //响应消息</span><br><span class="line">        SubscribeRespProto.SubscribeResp.Builder builder = SubscribeRespProto.SubscribeResp.newBuilder();</span><br><span class="line">        builder.setRespCode(200);</span><br><span class="line">        builder.setSubReqId(1);</span><br><span class="line">        builder.setDesc(&quot;success receive!&quot;);</span><br><span class="line">        SubscribeRespProto.SubscribeResp build = builder.build();</span><br><span class="line"></span><br><span class="line">        ctx.channel().writeAndFlush(build);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void channelReadComplete(ChannelHandlerContext ctx) &#123;</span><br><span class="line">        ctx.flush();//将消息从发送缓冲区中写入socketchannel中</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动调试"><a href="#启动调试" class="headerlink" title="启动调试"></a>启动调试</h2><p>完成以上操作、配置后，就可以先启动Server.java，再打开TestProtobuf.html，进行调试了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/08/20211108-replaceIfElse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/08/20211108-replaceIfElse/" class="post-title-link" itemprop="url">Java中if else替代方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-08 14:13:40" itemprop="dateCreated datePublished" datetime="2021-11-08T14:13:40+08:00">2021-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-14 15:50:26" itemprop="dateModified" datetime="2021-12-14T15:50:26+08:00">2021-12-14</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/11/08/20211108-replaceIfElse/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/11/08/20211108-replaceIfElse/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在我们平时的开发过程中，经常可能会出现大量If else的场景，代码显的很臃肿，非常不优雅，且难以维护。那我们有没有办法处理呢？</p>
<h2 id="工厂模式-枚举"><a href="#工厂模式-枚举" class="headerlink" title="工厂模式+枚举"></a>工厂模式+枚举</h2><p>工厂模式<br>将操作进行抽象给出一个操作接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface IOperation &#123;</span><br><span class="line">    int apply(int a, int b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后实现加减乘除四个方法</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class Addition implements IOperation &#123;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public int apply(int a, int b) &#123;</span><br><span class="line">        return a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    public enum OperationEnum &#123;</span><br><span class="line">        // 唯一枚举:</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        private Addition type = new Addition();</span><br><span class="line"></span><br><span class="line">        public Addition getType() &#123;</span><br><span class="line">            return this.type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setType(Addition type) &#123;</span><br><span class="line">            this.type = type;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用枚举</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public enum OperatorEnum &#123;</span><br><span class="line">    ADD(1, &quot;加法&quot;, Addition.OperatorEnum.INSTANCE.getType())</span><br><span class="line">    </span><br><span class="line">    private final int code;</span><br><span class="line"></span><br><span class="line">    private final String remark;</span><br><span class="line"></span><br><span class="line">    private final Operation operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int code= 1</span><br><span class="line">IOperation operation = OperatorEnum.valueOf(1).getOperation();</span><br><span class="line">result = shelfType.handleRefundSuccess(reqDTO);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xrq730/p/10633761.html">https://www.cnblogs.com/xrq730/p/10633761.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/java-my-life/archive/2012/05/28/2516865.html">https://www.cnblogs.com/java-my-life/archive/2012/05/28/2516865.html</a></p>
<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1559667">https://cloud.tencent.com/developer/article/1559667</a></p>
<h2 id="规则引擎"><a href="#规则引擎" class="headerlink" title="规则引擎"></a>规则引擎</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1559667">https://cloud.tencent.com/developer/article/1559667</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/28/20210901-javaWord/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/28/20210901-javaWord/" class="post-title-link" itemprop="url">javaWord</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-28 18:53:23" itemprop="dateCreated datePublished" datetime="2021-08-28T18:53:23+08:00">2021-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-08 14:07:55" itemprop="dateModified" datetime="2021-11-08T14:07:55+08:00">2021-11-08</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/08/28/20210901-javaWord/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/28/20210901-javaWord/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="使用poi操作word"><a href="#使用poi操作word" class="headerlink" title="使用poi操作word"></a>使用poi操作word</h2><ol>
<li><p>maven依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- word, ppt, excel 文件的读取 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;poi-scratchpad&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.poi.xwpf.usermodel.*;</span><br><span class="line">import org.openxmlformats.schemas.wordprocessingml.x2006.main.CTRow;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.regex.Matcher;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 相关服务接口</span><br><span class="line"> *</span><br><span class="line"></span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">public class WordGenerator &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 修改word到指定的目录</span><br><span class="line">     * @param filename 源文件</span><br><span class="line">     * @param data 模板数据</span><br><span class="line">     * @param dest 目标目录</span><br><span class="line">     * @throws IOException</span><br><span class="line">     */</span><br><span class="line">    public static void modifyWordToDest(File filename, Map&lt;String, Object&gt; data, String dest) throws IOException &#123;</span><br><span class="line">        FileInputStream is = new FileInputStream(filename.getAbsoluteFile());</span><br><span class="line">        modifyWordToDest(is, filename.getName(), data, dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 修改word到指定的目录</span><br><span class="line">     * @param is 文件输入流</span><br><span class="line">     * @param fileName 生成文件名</span><br><span class="line">     * @param data 模板数据</span><br><span class="line">     * @param dest 目标目录</span><br><span class="line">     * @throws IOException</span><br><span class="line">     */</span><br><span class="line">    public static void modifyWordToDest(InputStream is, String fileName, Map&lt;String, Object&gt; data, String dest) throws IOException &#123;</span><br><span class="line">        String tmpFilePath = dest + File.separator + fileName;</span><br><span class="line">        File dir = new File(dest);</span><br><span class="line">        if (!dir.exists()) &#123;</span><br><span class="line">            dir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputStream os = new FileOutputStream(tmpFilePath, false);</span><br><span class="line">        try &#123;</span><br><span class="line">            XWPFDocument document = new XWPFDocument(is);</span><br><span class="line"></span><br><span class="line">            // 替换段落里面的占位符</span><br><span class="line">            replaceInPara(document, data);</span><br><span class="line"></span><br><span class="line">            // 替换表格里的占位符</span><br><span class="line">            tableSearchAndReplace(document, data);</span><br><span class="line"></span><br><span class="line">            // 输出</span><br><span class="line">            document.write(os);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;WordGenerator modifyWordToDest error, fileName:&#123;&#125;&quot;,fileName,e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            close(is);</span><br><span class="line">            close(os);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * poi 查找word表格中占位符并替换</span><br><span class="line">     * 表格占位符格式：$&#123;name&#125;</span><br><span class="line">     * @param document</span><br><span class="line">     * @param data</span><br><span class="line">     */</span><br><span class="line">     public static final void tableSearchAndReplace(XWPFDocument document, Map&lt;String, Object&gt; data) &#123;</span><br><span class="line">         // 替换表格中的指定文字</span><br><span class="line">         Iterator&lt;XWPFTable&gt; itTable = document.getTablesIterator();</span><br><span class="line"></span><br><span class="line">         while (itTable.hasNext()) &#123;</span><br><span class="line">             XWPFTable table = (XWPFTable) itTable.next();</span><br><span class="line"></span><br><span class="line">             // 动态处理表格中的list，动态新增行</span><br><span class="line">             Iterator&lt;Map.Entry&lt;String, Object&gt;&gt; dataIterator = data.entrySet().iterator();</span><br><span class="line">             while (dataIterator.hasNext()) &#123;</span><br><span class="line">                 Map.Entry&lt;String, Object&gt; entry = dataIterator.next();</span><br><span class="line">                 if (entry.getValue() instanceof List) &#123;</span><br><span class="line">                     int rcount = table.getNumberOfRows();</span><br><span class="line">                     for (int i = rcount - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">                         XWPFTableRow row = table.getRow(i);</span><br><span class="line">                         boolean findListPara = false;</span><br><span class="line">                         List&lt;XWPFTableCell&gt; cells = row.getTableCells();</span><br><span class="line">                         for (XWPFTableCell cell : cells) &#123;</span><br><span class="line">                             //表格中处理段落（回车）</span><br><span class="line">                             List&lt;XWPFParagraph&gt; cellParList= cell.getParagraphs();</span><br><span class="line">                             for (XWPFParagraph xwpfParagraph : cellParList) &#123;</span><br><span class="line">                                 findListPara = findListParaInPara(xwpfParagraph, entry.getKey());</span><br><span class="line">                                 if (findListPara) &#123;</span><br><span class="line">                                     break;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                             if (findListPara) &#123;</span><br><span class="line">                                 break;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line">                         /** 处理找到list参数的这行数据 **/</span><br><span class="line">                         if (findListPara) &#123;</span><br><span class="line">                             // 遍历dataMap,valueList</span><br><span class="line">                             List valueList = (List) entry.getValue();</span><br><span class="line">                             for (int j = 0; j &lt; valueList.size(); j++) &#123;</span><br><span class="line">                                 // 设置map值</span><br><span class="line">                                 ObjectMapper mapObject = new ObjectMapper();</span><br><span class="line">                                 Map&lt;String, Object&gt; dataMap = mapObject.convertValue(valueList.get(j), Map.class);</span><br><span class="line"></span><br><span class="line">                                 // copy模板行为新增行</span><br><span class="line">                                 XWPFTableRow sourceRow = new XWPFTableRow((CTRow)table.getRow(i).getCtRow().copy(), table);</span><br><span class="line">                                 // 新增行替换参数</span><br><span class="line">                                 replaceInPara(sourceRow, dataMap);</span><br><span class="line">                                 // 添加到模板行之后</span><br><span class="line">                                 table.addRow(sourceRow, i + j + 1);</span><br><span class="line"></span><br><span class="line">                                 if (j == valueList.size() - 1) &#123;</span><br><span class="line">                                     // 最后一次移除模板行</span><br><span class="line">                                     table.removeRow(i);</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             // 处理表格中的替代符</span><br><span class="line">             int rcount = table.getNumberOfRows();</span><br><span class="line">             for (int i = 0; i &lt; rcount; i++) &#123;</span><br><span class="line">                 replaceInPara(table.getRow(i), data);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     private static void replaceInPara(XWPFTableRow row, Map&lt;String, Object&gt; data) &#123;</span><br><span class="line">         List&lt;XWPFTableCell&gt; cells = row.getTableCells();</span><br><span class="line">         for (XWPFTableCell cell : cells) &#123;</span><br><span class="line">             //表格中处理段落（回车）</span><br><span class="line">             List&lt;XWPFParagraph&gt; cellParList= cell.getParagraphs();</span><br><span class="line">             for (XWPFParagraph xwpfParagraph : cellParList) &#123;</span><br><span class="line">                 replaceInPara(xwpfParagraph, data);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 替换段落里面的变量 段落占位符格式：$&#123;name&#125;</span><br><span class="line">     * @param doc</span><br><span class="line">     * @param params</span><br><span class="line">     */</span><br><span class="line">    private static void replaceInPara(XWPFDocument doc, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        Iterator&lt;XWPFParagraph&gt; iterator = doc.getParagraphsIterator();</span><br><span class="line">        XWPFParagraph para;</span><br><span class="line">        while (iterator.hasNext()) &#123;</span><br><span class="line">            para = iterator.next();</span><br><span class="line">            replaceInPara(para, params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 替换段落里面的变量</span><br><span class="line">     * @param para</span><br><span class="line">     * @param params</span><br><span class="line">     */</span><br><span class="line">    private static void replaceInPara(XWPFParagraph para, Map&lt;String, Object&gt; params) &#123;</span><br><span class="line">        List&lt;XWPFRun&gt; runs;</span><br><span class="line">        Matcher matcher;</span><br><span class="line">        String runText = &quot;&quot;;</span><br><span class="line">        int fontSize = 15; // 默认字号</span><br><span class="line">        String fontFamily = &quot;楷体&quot;; // 默认字体</span><br><span class="line">        boolean bold = false; // 默认不加粗</span><br><span class="line"></span><br><span class="line">        if (matcher(para.getParagraphText()).find()) &#123;</span><br><span class="line">            runs = para.getRuns();</span><br><span class="line">            if (runs.size() &gt; 0) &#123;</span><br><span class="line">                int j = runs.size();</span><br><span class="line">                for (int i = 0; i &lt; j; i++) &#123;</span><br><span class="line">                    XWPFRun run = runs.get(0);</span><br><span class="line">                    fontSize = run.getFontSize();</span><br><span class="line">                    fontFamily = run.getFontFamily();</span><br><span class="line">                    bold = run.isBold();</span><br><span class="line">                    String i1 = run.toString();</span><br><span class="line">                    runText += i1;</span><br><span class="line">                    // 删除</span><br><span class="line">                    para.removeRun(0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            matcher = matcher(runText);</span><br><span class="line"></span><br><span class="line">            if (matcher.find()) &#123;</span><br><span class="line">                while ((matcher = matcher(runText)).find()) &#123;</span><br><span class="line">                    runText = matcher.replaceFirst(params.get(matcher.group(1)) != null ? String.valueOf(params.get(matcher.group(1))):&quot;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                // 直接调用XWPFRun的setText()方法设置文本时，在底层会重新创建一个XWPFRun，把文本附加在当前文本后面，</span><br><span class="line">                // 所以我们不能直接设值，需要先删除当前run,然后再自己手动插入一个新的run。</span><br><span class="line">                XWPFRun xwpfRun = para.insertNewRun(0);</span><br><span class="line">                xwpfRun.setBold(bold);</span><br><span class="line">                xwpfRun.setFontSize(fontSize);</span><br><span class="line">                xwpfRun.setFontFamily(fontFamily);</span><br><span class="line">                xwpfRun.setText(runText);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 查询段落里面是list类型的变量</span><br><span class="line">     * @param para</span><br><span class="line">     * @param key</span><br><span class="line">     */</span><br><span class="line">    private static boolean findListParaInPara(XWPFParagraph para, String key) &#123;</span><br><span class="line">        List&lt;XWPFRun&gt; runs;</span><br><span class="line">        String runText = &quot;&quot;;</span><br><span class="line">        Matcher matcher;</span><br><span class="line"></span><br><span class="line">        if (matcher(para.getParagraphText()).find()) &#123;</span><br><span class="line">            runs = para.getRuns();</span><br><span class="line">            if (runs.size() &gt; 0) &#123;</span><br><span class="line">                int j = runs.size();</span><br><span class="line">                for (int i = 0; i &lt; j; i++) &#123;</span><br><span class="line">                    XWPFRun run = runs.get(i);</span><br><span class="line">                    runText += run.toString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            matcher = matcher(runText);</span><br><span class="line"></span><br><span class="line">            if (matcher.find()) &#123;</span><br><span class="line">                if (matcher.group(1).equals(key)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 正则匹配字符串</span><br><span class="line">     *</span><br><span class="line">     * @param str</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static Matcher matcher(String str) &#123;</span><br><span class="line">        Pattern pattern = Pattern.compile(&quot;\\$\\&#123;(.+?)\\&#125;&quot;, Pattern.CASE_INSENSITIVE);</span><br><span class="line">        Matcher matcher = pattern.matcher(str);</span><br><span class="line">        return matcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void close(InputStream is) &#123;</span><br><span class="line">        if (is != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void close(OutputStream os) &#123;</span><br><span class="line">        if (os != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                os.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> ```  </span><br><span class="line">3. 准备模板文件</span><br><span class="line">![docx模板](../image/javaWordTemplate.jpg)</span><br><span class="line"></span><br><span class="line">4. 结果</span><br><span class="line">![生成的目录](../image/javaWordFolder.jpg)</span><br><span class="line">![目录内容](../image/javaWordResult.jpg)</span><br><span class="line"></span><br><span class="line">## 遇到的问题及相应的解决方案</span><br><span class="line"></span><br><span class="line">### jar启动项目遇到的问题</span><br><span class="line">1. 获取resource目录</span><br><span class="line">正确方式：</span><br></pre></td></tr></table></figure>
<p>getClass().getClassLoader().getResourceAsStream(“doc/a.docx”)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">错误方式：</span><br></pre></td></tr></table></figure>
<p>getClass().getClassLoader().getResource(“doc/a.docx”)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">错误方式在jar包启动的项目中会有问题，具体原因可以网上查下原因，不展开</span><br><span class="line"></span><br><span class="line">2. 获取jar包所在目录路径</span><br></pre></td></tr></table></figure>
<p>ApplicationHome h = new ApplicationHome(getClass());<br>File jarF = h.getSource();<br>String sysResPath = jarF.getParentFile().toString();</p>
<pre><code>[参考](https://blog.csdn.net/liangcha007/article/details/88526181)</code></pre>
</li>
<li><p>getResourceAsStream碰到中文目录<br>在本地启动过程时，文件目录采用中文命名（注：不是文件里面的中文内容），例如：new File(“目录/测试.docx”) ，没有任何问题，可以正常读取到。但部署到服务器上通过jar启动，则提示java.io.FileNotFoundException，暂时还未找到解决办法，如果有人了解，可以联系我，一起讨论下。</p>
</li>
</ol>
<h3 id="word中表格动态新增行"><a href="#word中表格动态新增行" class="headerlink" title="word中表格动态新增行"></a>word中表格动态新增行</h3><p>可以参考代码</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/04/20210804-netty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/04/20210804-netty/" class="post-title-link" itemprop="url">Netty</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-04 10:33:14" itemprop="dateCreated datePublished" datetime="2021-08-04T10:33:14+08:00">2021-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-02 11:04:31" itemprop="dateModified" datetime="2021-12-02T11:04:31+08:00">2021-12-02</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/08/04/20210804-netty/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/04/20210804-netty/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h2><ol>
<li>三大核心：Channel(通道)、Buffer(缓冲区)、Selector(选择器)</li>
</ol>
<h2 id="原生NIO存在的问题"><a href="#原生NIO存在的问题" class="headerlink" title="原生NIO存在的问题"></a>原生NIO存在的问题</h2><ol>
<li>NIO的类库和API繁琐，使用麻烦：需要熟练掌握Selector、ServerSocketChannel、ServerSocket、ByteBuffer等。</li>
<li>需要具备其他的额外技能：要熟悉 Java 多线程编程，因为 NIO 编程涉及到 Reactor 模式，你必须对多线程和网络编程非常熟悉，才能编写出高质量的 NIO 程序。</li>
<li>开发工作量和难度都非常大：例如客户端面临断线重连、网络闪断、半包读写、失败缓存、网络堵塞和异常流的处理等等。</li>
<li>JDK NIO 的 Bug：例如臭名昭著的 Epoll Bug，它会导致 Selector 空轮询，最终导致 CPU 100%。直到 JDK 1.7 版本该问题仍旧存在，没有被根本解决。</li>
</ol>
<h2 id="线程模型"><a href="#线程模型" class="headerlink" title="线程模型"></a>线程模型</h2><h3 id="单-Reactor-模式"><a href="#单-Reactor-模式" class="headerlink" title="单 Reactor 模式"></a>单 Reactor 模式</h3><p><img src="/image/reactor.png"></p>
<h3 id="单-Reactor-单线程"><a href="#单-Reactor-单线程" class="headerlink" title="单 Reactor 单线程"></a>单 Reactor 单线程</h3><p><img src="/image/reactorSingleThread.png" alt="NIO 群聊"></p>
<h3 id="单-Reactor-多线程"><a href="#单-Reactor-多线程" class="headerlink" title="单 Reactor 多线程"></a>单 Reactor 多线程</h3><p><img src="/image/reactor1.jpg"><br>优点：可以充分的利用多核cpu的处理能力。<br>缺点：多线程数据共享和访问比较复杂，reactor 处理所有的事件的监听和响应，在单线程运行，在高并发场景容易出现性能瓶颈。</p>
<h3 id="主从-Reactor-多线程"><a href="#主从-Reactor-多线程" class="headerlink" title="主从 Reactor 多线程"></a>主从 Reactor 多线程</h3><p><img src="/image/reactor2.jpg"></p>
<ol>
<li>Reactor 主线程 MainReactor 对象通过 select 监听链接事件，收到时间后，通过 Acceptor 处理链接事件。</li>
<li>当 Acceptor 处理链接事件后，MainReactor 将连接分配给 SubReactor.</li>
<li>subreactor 将连接加入到连接队列进行监听，并创建 handler 进行各种事件处理。</li>
<li>当有新事件发生时，subreactor 就会调用对应的 handler 处理。</li>
<li>handler 通过 read 读取数据，分发给后面的 worker 线程处理。</li>
<li>worker 线程池分配独立的 worker 线程进行业务处理，并返回结果。</li>
<li>handler 收到响应的结果后，再通过 send 将结果返回给client。</li>
<li><strong>Reactor 主线程可以对应多个 Reactor 子线程，即 MainReactor 可以关联多个 subreactor</strong></li>
</ol>
<h4 id="方案优缺点"><a href="#方案优缺点" class="headerlink" title="方案优缺点"></a>方案优缺点</h4><p>优点：</p>
<ol>
<li>父线程与子线程的数据交互简单职责明确，父线程只需要接收新连接，子线程完成后续的业务处理。</li>
<li>父线程与子线程的数据交互简单，Reactor 主线程只需要把新连接传给子线程，子线程无需返回数据。</li>
</ol>
<p>缺点：</p>
<ol>
<li>编程复杂度较高</li>
</ol>
<p>结合实例：这种模型在许多项目中广泛使用，包括 Nginx 主从 Reactor 多进程模型，Memcached 主从多线程，Netty 主从多线程模型的支持。</p>
<p><a target="_blank" rel="noopener" href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">Scalable IO in Java</a> 书中作者 <a target="_blank" rel="noopener" href="https://zh.wikiqube.net/wiki/Doug_Lea">Doug Lea</a> 对 Reactor 模型的理解</p>
<h2 id="Netty-模型"><a href="#Netty-模型" class="headerlink" title="Netty 模型"></a>Netty 模型</h2><p><img src="/image/netty.jpg" alt="工作原理示意图"><br>工作原理示意图-解析</p>
<ol>
<li>Netty抽象出两组线程池BossGroup专门负责接收客户端的连接，WorkerGroup专门负责网络的读写。</li>
<li>BossGroup和WorkerGroup类型都是NioEventLoopGroup</li>
<li>NioEventLoopGroup相当于一个事件循环组，这个组中含有多个事件循环，每个事件循环是NioEventLoop</li>
<li>NioEventLoop 表示一个不断循环的执行处理任务的线程，每个NioEventLoop都有一个selector，用于监听绑定在其上的socket的网络通讯</li>
<li>NioEventLoopGroup 可以有多个线程，即可以含有多个NioEventLoop</li>
<li>每个Boss NioEventLoop 执行的步骤有3步：<ol>
<li>轮询accept事件</li>
<li>处理accept事件，与client建立连接，生成 NioSocketChannel，并将其注册到某个worker NIOEventLoop 上的selector</li>
<li>处理任务队列的任务，即 runAllTasks</li>
</ol>
</li>
<li>每个Worker NIOEventLoop 循环执行的步骤<ol>
<li>轮询read,write事件</li>
<li>处理i/o事件，即read,write事件，在对应 NioSocketChannel 处理</li>
<li>处理任务队列的任务，即 runAllTasks</li>
</ol>
</li>
<li>每个Worker NIOEventLoop 处理业务时，会使用pipeline（管道），pipeline 中包含了 channel，即通过pipeline 可以获取到对应通道，管道中维护了很多的处理器。</li>
</ol>
<h2 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h2><p>http + json -&gt; tcp + protobuf<br>Protobuf优点：</p>
<ol>
<li>序列化后体积相比Json和XML很小，适合网络传输</li>
<li>支持跨平台多语言</li>
<li>消息格式升级和兼容性还不错</li>
<li>序列化反序列化速度很快，快于Json的处理速速</li>
</ol>
<p>Protobuf缺点：</p>
<ol>
<li>二进制格式导致可读性差</li>
<li>缺乏自描述</li>
<li>通用性差</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a24c88c0526a">文档</a></p>
<h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><ol>
<li>不论解码器handler还是编码器handler，接收的消息类型必须与待处理的消息类型一致，否则该handler不会被执行</li>
<li>在解码器进行数据解码时，需要判断缓存区（ByteBuf）的数据是否足够，否则接收到的结果与期望结果可能不一致</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">语言指南</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="D:\BaiduNetdiskDownload\尚硅谷Netty学习资料">课件</a><br><a target="_blank" rel="noopener" href="https://dongzl.github.io/netty-handbook/#/">笔记</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1754078">https://cloud.tencent.com/developer/article/1754078</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/24/20210723_DApp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/24/20210723_DApp/" class="post-title-link" itemprop="url">DApp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-24 17:15:15" itemprop="dateCreated datePublished" datetime="2021-07-24T17:15:15+08:00">2021-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-30 14:07:49" itemprop="dateModified" datetime="2021-07-30T14:07:49+08:00">2021-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index"><span itemprop="name">Project</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/07/24/20210723_DApp/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/07/24/20210723_DApp/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="以太坊客户端安装"><a href="#以太坊客户端安装" class="headerlink" title="以太坊客户端安装"></a>以太坊客户端安装</h2><p><a target="_blank" rel="noopener" href="https://ethereumdocch.readthedocs.io/zh/latest/ethereum-clients/index.html">以太坊客户端介绍</a></p>
<p>我们选择其中一个主流的客户端go-ethereum（Geth）进行安装。以Windows为例：<br>执行：<br><code>pkg install go-ethereum</code></p>
<p><a target="_blank" rel="noopener" href="https://geth.ethereum.org/docs/install-and-build/installing-geth">其他环境安装</a></p>
<h2 id="链搭建"><a href="#链搭建" class="headerlink" title="链搭建"></a>链搭建</h2><p>以搭建私链为例：</p>
<ol>
<li><p>新建目录（eth-pri）</p>
</li>
<li><p>执行启动命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth --datadir ether-pri --rpcapi=&quot;db,eth,net,web3,miner,personal,web3&quot; --http --dev --dev.period 10 --http.corsdomain &quot;https://remix.ethereum.org,http://remix.ethereum.org&quot;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://geth.ethereum.org/docs/interface/command-line-options">参数说明</a></p>
</li>
<li><p>连接客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth attach http://localhost:8545</span><br></pre></td></tr></table></figure></li>
<li><p>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">账号</span><br><span class="line">    创建：personal.newAccount()</span><br><span class="line">    获取账号：eth.accounts</span><br><span class="line">    获取余额：eth.getBalance(&quot;sssss&quot;)</span><br><span class="line">    解锁账号：personal.unlockAccount(user1,password)</span><br><span class="line"></span><br><span class="line">挖矿</span><br><span class="line">    开始：miner.start()</span><br><span class="line">    结束：miner.stop()</span><br><span class="line">    设置挖矿奖励用户：miner.setEtherbase(user3)</span><br><span class="line"></span><br><span class="line">转账</span><br><span class="line">    u1 = eth.accounts[0]</span><br><span class="line">    u2 = eth.accounts[1]</span><br><span class="line">    eth.sendTransaction(&#123;from:u1, to:u2, value:web3.toWei(10, &quot;ether&quot;)&#125;)</span><br><span class="line"></span><br><span class="line">交易前解锁账号</span><br><span class="line">    personal.unlockAcount(u1, password)</span><br><span class="line"></span><br><span class="line">交易完需要挖矿来确认</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://web3js.readthedocs.io/en/v1.2.9/">其他命令操作</a> 可以参考Web3js</p>
</li>
</ol>
<h2 id="合约"><a href="#合约" class="headerlink" title="合约"></a>合约</h2><h3 id="合约开发"><a href="#合约开发" class="headerlink" title="合约开发"></a>合约开发</h3><p><a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/v0.8.6/">solidity英文开发文档</a><br><a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/solidity/index.html">solidity中文开发文档</a></p>
<p>(合约调用的四种方式](<a target="_blank" rel="noopener" href="https://blog.csdn.net/TurkeyCock/article/details/83826531">https://blog.csdn.net/TurkeyCock/article/details/83826531</a>)<br>library:公共代码复用，不允许定义任何storage类型的变量，不能修改合约的状态。</p>
<h3 id="合约编译、部署"><a href="#合约编译、部署" class="headerlink" title="合约编译、部署"></a>合约编译、部署</h3><h4 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a><a target="_blank" rel="noopener" href="https://remix.ethereum.org/">Remix</a></h4><p>remix访问本地：</p>
<ol>
<li>uninstall the old one： <code>npm uninstall -g remixd</code></li>
<li>install the new： <code>npm install -g @remix-project/remixd</code></li>
<li>share folder： <code>remixd -s &lt;absolute-path&gt; --remix-ide https://remix.ethereum.org</code></li>
</ol>
<h4 id="Truffle"><a href="#Truffle" class="headerlink" title="Truffle"></a>Truffle</h4><p><a target="_blank" rel="noopener" href="https://truffle.tryblockchain.org/Solidity-truffle-%e5%ae%9e%e6%88%98.html">文档</a><br><a target="_blank" rel="noopener" href="https://github.com/ChenJFMorton/truffleTest">Truffle、Solidity合约项目Demo</a></p>
<ol>
<li>初始化truffle项目：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">truffle init</span><br></pre></td></tr></table></figure></li>
<li>solidity安装外部依赖：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ERC20依赖</span><br><span class="line">npm install  @openzeppelin/contracts</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="合约调试"><a href="#合约调试" class="headerlink" title="合约调试"></a>合约调试</h3><p><a target="_blank" rel="noopener" href="https://github.com/nomiclabs/buidler-evm-demo">Buidler</a>内置了Buidler EVM ，这是一个专为开发而设计的以太坊网络。它允许你部署合约，运行测试和调试代码。可以将合约部署到buidler-evm上，调试完再部署到实际使用的链上。<br>使用步骤：</p>
<ol>
<li>启动（每次启动貌似起个新链，之前部署的合约都不存在了）<br><code>npx buidler node</code></li>
<li>合约项目下载Buidler依赖<br><code>npm install @nomiclabs/buidler</code></li>
<li>合约引入console依赖<br><code>import &quot;@nomiclabs/buidler/console.sol&quot;;</code></li>
<li>使用日志打印<br><code>console.log(&quot;value:&quot;, 11);</code><br>注：<br>支持的solidity版本 &lt; 0.8.0，如果solidity版本&gt;=0.8.0，可以修改console源码，把byte类型相关去除</li>
</ol>
<p>其他资料：<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1679411">https://cloud.tencent.com/developer/article/1679411</a><br><a target="_blank" rel="noopener" href="https://www.blockvalue.com/news/2019100619910.html">https://www.blockvalue.com/news/2019100619910.html</a></p>
<h2 id="前端开发"><a href="#前端开发" class="headerlink" title="前端开发"></a>前端开发</h2><p><a target="_blank" rel="noopener" href="https://github.com/ChenJFMorton/guess">Demo地址</a><br>Vue + Element-Ui + Web3js</p>
<ol>
<li>创建Vue项目<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">安装vue：npm install -g vue-cli</span><br><span class="line">初始化vue项目：vue init webpack my-project</span><br><span class="line">安装web3：npm install web3@1.3.1</span><br><span class="line">启动项目：npm run dev</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Java调用合约"><a href="#Java调用合约" class="headerlink" title="Java调用合约"></a>Java调用合约</h2><ol>
<li><p>pom.xml引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.web3j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.8.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.web3j&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;codegen&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.8.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>通过abi文件生成java类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static void transformABI() throws Exception &#123;</span><br><span class="line">    //org.web3j.codegen.TruffleJsonFunctionWrapperGenerator /path/to/&lt;truffle-smart-contract-output&gt;.json -o /path/to/src/main/java -p com.your.organisation.name</span><br><span class="line">    TruffleJsonFunctionWrapperGenerator.main(new String[]&#123;&quot;D:\\developtools\\truffle\\workspace\\truffleTest\\build\\contracts\\GuessVote.json&quot;,&quot;-o&quot;,&quot;D:/git/netease-leihuo/ethereum-test/src/main/java&quot;,&quot;-p&quot;,&quot;com.cjf.web3j.abi&quot;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>合约中方法调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// 默认链接到，或者自己指定 http://localhost:8545/</span><br><span class="line">Web3j web3 = Web3j.build(new HttpService()); </span><br><span class="line">//获取链接到的client的版本</span><br><span class="line">Web3ClientVersion web3ClientVersion = web3.web3ClientVersion().send();</span><br><span class="line">String clientVersion = web3ClientVersion.getWeb3ClientVersion();</span><br><span class="line">System.out.println(clientVersion);</span><br><span class="line"></span><br><span class="line">//获取当前gasprice</span><br><span class="line">EthGasPrice gasPrice = web3.ethGasPrice().send();</span><br><span class="line"></span><br><span class="line">BigInteger priceResult = gasPrice.getGasPrice();</span><br><span class="line">System.out.println(&quot;current gas price:&quot; + priceResult);</span><br><span class="line"></span><br><span class="line">//获取块的gasLimit</span><br><span class="line">EthBlock.Block block = web3.ethGetBlockByNumber(DefaultBlockParameterName.LATEST, false).send().getBlock();</span><br><span class="line">System.out.println(&quot;BLOCK GAS LIMIT:&quot; + block.getGasLimit());</span><br><span class="line"></span><br><span class="line">StaticGasProvider gasProvider = new StaticGasProvider(priceResult, block.getGasLimit());</span><br><span class="line"></span><br><span class="line">//使用私钥创建Credentials</span><br><span class="line">Credentials owner = Credentials.create(&quot;****&quot;);</span><br><span class="line"></span><br><span class="line">//需要指定chainId来创建TransactionManager ，否则交易会因为防重放攻击而无法被执行</span><br><span class="line">TransactionManager transactionManager = new RawTransactionManager(web3, owner, 1337);</span><br><span class="line"></span><br><span class="line">//获取一个链上已经存在的合约</span><br><span class="line">GuessVote guessVote = GuessVote.load(GuessVote.getPreviouslyDeployedAddress(&quot;1337&quot;), web3, transactionManager, gasProvider);</span><br><span class="line"></span><br><span class="line">// 调用合约中的方法</span><br><span class="line">TransactionReceipt s = guessVote.generateVoteResult().send();</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="MetaMask钱包"><a href="#MetaMask钱包" class="headerlink" title="MetaMask钱包"></a>MetaMask钱包</h2><p><a target="_blank" rel="noopener" href="https://docs.metamask.io/guide/getting-started.html">MetaMask文档</a><br>安装：<code>npm install metamask</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 获取最新区块</span><br><span class="line">const newestBlockNum = parseInt(</span><br><span class="line">          await ethereum.request(&#123;</span><br><span class="line">            method: &quot;eth_blockNumber&quot;,</span><br><span class="line">            params: [],</span><br><span class="line">          &#125;),</span><br><span class="line">          16</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">// 获取账号</span><br><span class="line">const accounts = await ethereum.request(&#123;</span><br><span class="line">        method: &quot;eth_requestAccounts&quot;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">// 获取账号余额</span><br><span class="line">const balance = await this.usstContract.methods</span><br><span class="line">          .balanceOf(this.account)</span><br><span class="line">          .call();</span><br></pre></td></tr></table></figure>

<h2 id="部署到测试链"><a href="#部署到测试链" class="headerlink" title="部署到测试链"></a>部署到测试链</h2><h3 id="币安测试链"><a href="#币安测试链" class="headerlink" title="币安测试链"></a>币安测试链</h3><p><a target="_blank" rel="noopener" href="https://docs.binance.org/smart-chain/developer/rpc.html">文档</a><br><a target="_blank" rel="noopener" href="https://docs.binance.org/smart-chain/wallet/metamask.html">水龙头相关文档</a><br><a target="_blank" rel="noopener" href="https://www.mytokencap.com/announcement/1072241.html">水龙头其他文档</a> </p>
<p>注：ip限制，充值不上换代理。</p>
<p>部署测试链步骤：</p>
<ol>
<li>修改truffle-config.js<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const HDWalletProvider = require(&#x27;@truffle/hdwallet-provider&#x27;);</span><br><span class="line"></span><br><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line">const mnemonic = fs.readFileSync(&quot;.secret&quot;).toString().trim();</span><br></pre></td></tr></table></figure>
networks增加配置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testnet: &#123;</span><br><span class="line">      provider: () =&gt; new HDWalletProvider(mnemonic, `https://data-seed-prebsc-2-s1.binance.org:8545`),</span><br><span class="line">      network_id: 97,</span><br><span class="line">      confirmations: 10,</span><br><span class="line">      timeoutBlocks: 200,</span><br><span class="line">      skipDryRun: true</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>部署命令<br><code>truffle migrate --network testnet</code></li>
</ol>
<h3 id="火币测试链"><a href="#火币测试链" class="headerlink" title="火币测试链"></a>火币测试链</h3><p><a href="www.hecochain.com">官网地址</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">测试网地址：</span><br><span class="line">    chainid 256</span><br><span class="line">    RPC wss://ws-testnet.hecochain.com</span><br><span class="line">    https://http-testnet.hecochain.com</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://scan-testnet.hecochain.com/">浏览器</a><br><a target="_blank" rel="noopener" href="https://scan-testnet.hecochain.com/faucet">测试币水龙头</a></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol>
<li>Exception in thread “main” java.lang.UnsupportedOperationException: Unsupported type encountered: tuple<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://stackoverflow.com/questions/48877910/how-can-i-return-an-array-of-struct-in-solidity</span><br></pre></td></tr></table></figure></li>
<li>合约多字段返回<br>java:元组<br>js:struct[]，调用call方法需要传account<br> <a target="_blank" rel="noopener" href="https://learnblockchain.cn/docs/web3.js/web3-eth-contract.html#methods-mymethod-call">参考文档</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/20200804_invertedIndex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/20200804_invertedIndex/" class="post-title-link" itemprop="url">搜索引擎是如何实现快速查询？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 15:15:15" itemprop="dateCreated datePublished" datetime="2020-08-04T15:15:15+08:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-30 14:07:49" itemprop="dateModified" datetime="2021-07-30T14:07:49+08:00">2021-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/04/20200804_invertedIndex/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/04/20200804_invertedIndex/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么需要搜索引擎？"><a href="#为什么需要搜索引擎？" class="headerlink" title="为什么需要搜索引擎？"></a>为什么需要搜索引擎？</h2><p>用数据库，也可以实现搜索的功能，为什么还需要搜索引擎呢？</p>
<p>就像 <a href="https://link.zhihu.com/?target=https://stackoverflow.com/questions/51639166/elasticsearch-vs-relational-database">Stackoverflow</a> 的网友说的：</p>
<blockquote>
<p>A relational database can store data and also index it. A search engine can index data but also store it.</p>
</blockquote>
<p>数据库（理论上来讲，ES 也是数据库，这里的数据库，指的是关系型数据库），首先是存储，搜索只是顺便提供的功能，</p>
<p>而搜索引擎，首先是搜索，但是不把数据存下来就搜不了，所以只好存一存。</p>
<p>术业有专攻，专攻搜索的搜索引擎，自然会提供更强大的搜索能力。</p>
<h2 id="搜索引擎凭什么比关系型数据库查询快？"><a href="#搜索引擎凭什么比关系型数据库查询快？" class="headerlink" title="搜索引擎凭什么比关系型数据库查询快？"></a>搜索引擎凭什么比关系型数据库查询快？</h2><p>Elasticsearch 是通过 Lucene 的倒排索引技术实现比关系型数据库更快的过滤。特别是它对多条件的过滤支持非常好，比如年龄在 18 和 30 之间，性别为女性这样的组合查询。倒排索引很多地方都有介绍，</p>
<p>笼统的来说，<a href="%5Bhttps://zh.wikipedia.org/wiki/B+%E6%A0%91%5D(https://zh.wikipedia.org/wiki/B+%E6%A0%91)"><strong>b-tree</strong></a> 索引是为写入优化的索引结构。当我们不需要支持快速的更新的时候，可以用预先排序等方式换取更小的存储空间，更快的检索速度等好处，其代价就是更新慢。要进一步深入的化，还是要看一下 Lucene 的倒排索引是怎么构成的。</p>
<p>先看倒排索引的构成</p>
<p><img src="https://pic.downk.cc/item/5f2a219314195aa594b7dd8a.jpg"></p>
<p>这里对应的名字概念，举个实际的例子</p>
<table>
<thead>
<tr>
<th>docid</th>
<th>age</th>
<th>sex</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>18</td>
<td>女</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>女</td>
</tr>
<tr>
<td>3</td>
<td>18</td>
<td>男</td>
</tr>
</tbody></table>
<p>这里每一行是一个 document。每个 document 都有一个 docid。那么给这些 document 建立的倒排索引就是：age和sex</p>
<p>可以看到，倒排索引是 per field 的，一个字段有一个自己的倒排索引。18,20 这些叫做 term，而 [1,3] 就是 posting list。Posting list 就是一个 int 的数组，存储了所有符合某个 term 的文档 id。那么什么是 term dictionary 和 term index？</p>
<p>假设我们有很多个 term，比如：</p>
<p><strong>Carla,Sara,Elin,Ada,Patty,Kate,Selena</strong></p>
<p>如果按照这样的顺序排列，找出某个特定的 term 一定很慢，因为 term 没有排序，需要全部过滤一遍才能找出特定的 term。排序之后就变成了：</p>
<p><strong>Ada,Carla,Elin,Kate,Patty,Sara,Selena</strong></p>
<p>这样我们可以用二分查找的方式，比全遍历更快地找出目标的 term。这个就是 term dictionary。有了 term dictionary 之后，可以用 logN 次磁盘查找得到目标。但是磁盘的随机读操作仍然是非常昂贵的（一次 random access 大概需要 10ms 的时间）。所以尽量少的读磁盘，有必要把一些数据缓存到内存里。但是整个 term dictionary 本身又太大了，无法完整地放到内存里。于是就有了 term index。term index 有点像一本字典的目录。比如：</p>
<p>A 开头的 term ……………. Xxx 页</p>
<p>C 开头的 term ……………. Xxx 页</p>
<p>E 开头的 term ……………. Xxx 页</p>
<p>实际的 term index 是一棵 trie 树：</p>
<p><img src="https://pic.downk.cc/item/5f2a64bb14195aa594d9ddc0.png"></p>
<p>例子是一个包含 “A”, “to”, “tea”, “ted”, “ten”, “i”, “in”, 和 “inn” 的 trie 树。这棵树不会包含所有的 term，它包含的是 term 的一些前缀。通过 term index 可以快速地定位到 term dictionary 的某个 offset，然后从这个位置再往后顺序查找。再加上一些压缩技术（搜索 <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/572795">Lucene Finite State Transducers</a>） term index 的尺寸可以只有所有 term 的尺寸的几十分之一，使得用内存缓存整个 term index 变成可能。整体上来说就是这样的效果。</p>
<p><img src="https://pic.downk.cc/item/5f2a68f714195aa594dc032c.jpg"></p>
<p>现在我们可以回答“为什么 Elasticsearch/Lucene 检索可以比 mysql 快了。Mysql 只有 term dictionary 这一层，是以 b-tree 排序的方式存储在磁盘上的。检索一个 term 需要若干次的 random access 的磁盘操作。而 Lucene 在 term dictionary 的基础上添加了 term index 来加速检索，term index 以树的形式缓存在内存中。从 term index 查到对应的 term dictionary 的 block 位置之后，再去磁盘上找 term，大大减少了磁盘的 random access 次数。</p>
<p>额外值得一提的两点是：term index 在内存中是以 FST（finite state transducers）的形式保存的，其特点是非常节省内存。Term dictionary 在磁盘上是以分 block 的方式保存的，一个 block 内部利用公共前缀压缩，比如都是 Ab 开头的单词就可以把 Ab 省去。这样 term dictionary 可以比 b-tree 更节约磁盘空间。</p>
<h2 id="如何联合索引查询？"><a href="#如何联合索引查询？" class="headerlink" title="如何联合索引查询？"></a>如何联合索引查询？</h2><p>所以给定查询过滤条件 age=18 的过程就是先从 term index 找到 18 在 term dictionary 的大概位置，然后再从 term dictionary 里精确地找到 18 这个 term，然后得到一个 posting list 或者一个指向 posting list 位置的指针。然后再查询 gender= 女 的过程也是类似的。最后得出 age=18 AND gender= 女 就是把两个 posting list 做一个“与”的合并。</p>
<p>这个理论上的“与”合并的操作可不容易。对于 mysql 来说，如果你给 age 和 gender 两个字段都建立了索引，查询的时候只会选择其中最 selective 的来用，然后另外一个条件是在遍历行的过程中在内存中计算之后过滤掉。那么要如何才能联合使用两个索引呢？有两种办法：</p>
<ul>
<li>使用 skip list 数据结构。同时遍历 gender 和 age 的 posting list，互相 skip；</li>
<li>使用 bitset 数据结构，对 gender 和 age 两个 filter 分别求出 bitset，对两个 bitset 做 AN 操作。</li>
</ul>
<p>PostgreSQL 从 8.4 版本开始支持通过 bitmap 联合使用两个索引，就是利用了 bitset 数据结构来做到的。当然一些商业的关系型数据库也支持类似的联合索引的功能。Elasticsearch 支持以上两种的联合索引方式，如果查询的 filter 缓存到了内存中（以 bitset 的形式），那么合并就是两个 bitset 的 AND。如果查询的 filter 没有缓存，那么就用 skip list 的方式去遍历两个 on disk 的 posting list。</p>
<h3 id="利用-Skip-List-合并"><a href="#利用-Skip-List-合并" class="headerlink" title="利用 Skip List 合并"></a>利用 Skip List 合并</h3><p><img src="https://pic.downk.cc/item/5f2a695414195aa594dc2f73.jpg"></p>
<p>以上是三个 posting list。我们现在需要把它们用 AND 的关系合并，得出 posting list 的交集。首先选择最短的 posting list，然后从小到大遍历。遍历的过程可以跳过一些元素，比如我们遍历到绿色的 13 的时候，就可以跳过蓝色的 3 了，因为 3 比 13 要小。</p>
<p>整个过程如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Next -&gt; 2</span><br><span class="line">Advance(2) -&gt; 13</span><br><span class="line">Advance(13) -&gt; 13</span><br><span class="line">Already on 13</span><br><span class="line">Advance(13) -&gt; 13 MATCH!!!</span><br><span class="line">Next -&gt; 17</span><br><span class="line">Advance(17) -&gt; 22</span><br><span class="line">Advance(22) -&gt; 98</span><br><span class="line">Advance(98) -&gt; 98</span><br><span class="line">Advance(98) -&gt; 98 MATCH!!!</span><br></pre></td></tr></table></figure>

<p>最后得出的交集是 [13,98]，所需的时间比完整遍历三个 posting list 要快得多。但是前提是每个 list 需要指出 Advance 这个操作，快速移动指向的位置。什么样的 list 可以这样 Advance 往前做蛙跳？skip list：</p>
<p><img src="https://pic.downk.cc/item/5f2a69b514195aa594dc60f9.png"></p>
<p>从概念上来说，对于一个很长的 posting list，比如：</p>
<p>[1,3,13,101,105,108,255,256,257]</p>
<p>我们可以把这个 list 分成三个 block：</p>
<p>[1,3,13] [101,105,108] [255,256,257]</p>
<p>然后可以构建出 skip list 的第二层：</p>
<p>[1,101,255]</p>
<p>1,101,255 分别指向自己对应的 block。这样就可以很快地跨 block 的移动指向位置了。</p>
<p>Lucene 自然会对这个 block 再次进行压缩。其压缩方式叫做 Frame Of Reference 编码。示例如下：</p>
<p><img src="https://pic.downk.cc/item/5f2a69dd14195aa594dc74dd.png"></p>
<p>考虑到频繁出现的 term（所谓 low cardinality 的值），比如 gender 里的男或者女。如果有 1 百万个文档，那么性别为男的 posting list 里就会有 50 万个 int 值。用 Frame of Reference 编码进行压缩可以极大减少磁盘占用。这个优化对于减少索引尺寸有非常重要的意义。当然 mysql b-tree 里也有一个类似的 posting list 的东西，是未经过这样压缩的。</p>
<p>因为这个 Frame of Reference 的编码是有解压缩成本的。利用 skip list，除了跳过了遍历的成本，也跳过了解压缩这些压缩过的 block 的过程，从而节省了 cpu。</p>
<h3 id="利用-bitset-合并"><a href="#利用-bitset-合并" class="headerlink" title="利用 bitset 合并"></a>利用 bitset 合并</h3><p>Bitset 是一种很直观的数据结构，对应 posting list 如：</p>
<p>[1,3,4,7,10]</p>
<p>对应的 bitset 就是：</p>
<p>[1,0,1,1,0,0,1,0,0,1]</p>
<p>每个文档按照文档 id 排序对应其中的一个 bit。Bitset 自身就有压缩的特点，其用一个 byte 就可以代表 8 个文档。所以 100 万个文档只需要 12.5 万个 byte。但是考虑到文档可能有数十亿之多，在内存里保存 bitset 仍然是很奢侈的事情。而且对于个每一个 filter 都要消耗一个 bitset，比如 age=18 缓存起来的话是一个 bitset，18&lt;=age&lt;25 是另外一个 filter 缓存起来也要一个 bitset。</p>
<p>所以秘诀就在于需要有一个数据结构：</p>
<ul>
<li>可以很压缩地保存上亿个 bit 代表对应的文档是否匹配 filter；</li>
<li>这个压缩的 bitset 仍然可以很快地进行 AND 和 OR 的逻辑操作。</li>
</ul>
<p>Lucene 使用的这个数据结构叫做 Roaring Bitmap。</p>
<p><img src="https://pic.downk.cc/item/5f2a6a3914195aa594dca6d4.png"></p>
<p>其压缩的思路其实很简单。与其保存 100 个 0，占用 100 个 bit。还不如保存 0 一次，然后声明这个 0 重复了 100 遍。</p>
<p>这两种合并使用索引的方式都有其用途。Elasticsearch 对其性能有详细的对比（<a target="_blank" rel="noopener" href="https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps"> https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps </a>）。简单的结论是：因为 Frame of Reference 编码是如此 高效，对于简单的相等条件的过滤缓存成纯内存的 bitset 还不如需要访问磁盘的 skip list 的方式要快。</p>
<h3 id="如何减少文档数？"><a href="#如何减少文档数？" class="headerlink" title="如何减少文档数？"></a>如何减少文档数？</h3><p>一种常见的压缩存储时间序列的方式是把多个数据点合并成一行。Opentsdb 支持海量数据的一个绝招就是定期把很多行数据合并成一行，这个过程叫 compaction。类似的 vivdcortext 使用 mysql 存储的时候，也把一分钟的很多数据点合并存储到 mysql 的一行里以减少行数。</p>
<p>这个过程可以示例如下：</p>
<table>
<thead>
<tr>
<th>12:05:00</th>
<th>10</th>
</tr>
</thead>
<tbody><tr>
<td>12:05:01</td>
<td>15</td>
</tr>
<tr>
<td>12:05:02</td>
<td>14</td>
</tr>
<tr>
<td>12:05:03</td>
<td>16</td>
</tr>
</tbody></table>
<p>合并之后就变成了：</p>
<p>可以看到，行变成了列了。每一列可以代表这一分钟内一秒的数据。</p>
<p>Elasticsearch 有一个功能可以实现类似的优化效果，那就是 Nested Document。我们可以把一段时间的很多个数据点打包存储到一个父文档里，变成其嵌套的子文档。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;timestamp:12:05:01, idc:sz, value1:10,value2:11&#125;</span><br><span class="line">&#123;timestamp:12:05:02, idc:sz, value1:9,value2:9&#125;</span><br><span class="line">&#123;timestamp:12:05:02, idc:sz, value1:18,value:17&#125;</span><br></pre></td></tr></table></figure>

<p>可以打包成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">max_timestamp:12:05:02, min_timestamp: 1205:01, idc:sz,</span><br><span class="line">records: [</span><br><span class="line">		&#123;timestamp:12:05:01, value1:10,value2:11&#125;</span><br><span class="line">&#123;timestamp:12:05:02, value1:9,value2:9&#125;</span><br><span class="line">&#123;timestamp:12:05:02, value1:18,value:17&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样可以把数据点公共的维度字段上移到父文档里，而不用在每个子文档里重复存储，从而减少索引的尺寸。</p>
<p><img src="https://pic.downk.cc/item/5f2a6aa214195aa594dcd694.png"></p>
<p>（图片来源：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Su5SHc_uJw8"> https://www.youtube.com/watch?v=Su5SHc_uJw8 </a>，Faceting with Lucene Block Join Query）</p>
<p>在存储的时候，无论父文档还是子文档，对于 Lucene 来说都是文档，都会有文档 Id。但是对于嵌套文档来说，可以保存起子文档和父文档的文档 id 是连续的，而且父文档总是最后一个。有这样一个排序性作为保障，那么有一个所有父文档的 posting list 就可以跟踪所有的父子关系。也可以很容易地在父子文档 id 之间做转换。把父子关系也理解为一个 filter，那么查询时检索的时候不过是又 AND 了另外一个 filter 而已。前面我们已经看到了 Elasticsearch 可以非常高效地处理多 filter 的情况，充分利用底层的索引。</p>
<p>使用了嵌套文档之后，对于 term 的 posting list 只需要保存父文档的 doc id 就可以了，可以比保存所有的数据点的 doc id 要少很多。如果我们可以在一个父文档里塞入 50 个嵌套文档，那么 posting list 可以变成之前的 1/50。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>时间序列数据库的秘密 (2)——索引：<a target="_blank" rel="noopener" href="https://www.infoq.cn/article/database-timestamp-02/">https://www.infoq.cn/article/database-timestamp-02/</a></p>
<p>为什么需要 Elasticsearch：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/73585202">https://zhuanlan.zhihu.com/p/73585202</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/04/20201030_dataengineer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/04/20201030_dataengineer/" class="post-title-link" itemprop="url">数据工程师学习资料</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-04 15:15:15" itemprop="dateCreated datePublished" datetime="2020-08-04T15:15:15+08:00">2020-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-30 14:07:49" itemprop="dateModified" datetime="2021-07-30T14:07:49+08:00">2021-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%B8%88/" itemprop="url" rel="index"><span itemprop="name">数据工程师</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/04/20201030_dataengineer/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/04/20201030_dataengineer/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一个英文网站，按照学习次序，列出各种主题最推荐的学习资料。<br><a target="_blank" rel="noopener" href="https://awesomedataengineering.com/">https://awesomedataengineering.com/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/03/20200803_Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/03/20200803_Hexo/" class="post-title-link" itemprop="url">在Github上使用Hexo搭建Blog</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-03 11:15:15" itemprop="dateCreated datePublished" datetime="2020-08-03T11:15:15+08:00">2020-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-30 14:07:49" itemprop="dateModified" datetime="2021-07-30T14:07:49+08:00">2021-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Blog/" itemprop="url" rel="index"><span itemprop="name">Blog</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/08/03/20200803_Hexo/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/03/20200803_Hexo/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是个人的笔记记录，非详细的文档介绍。</p>
<h2 id="GitHub创建个人仓库"><a href="#GitHub创建个人仓库" class="headerlink" title="GitHub创建个人仓库"></a>GitHub创建个人仓库</h2><p>点击GitHub中的New repository创建新仓库，仓库名应该为：<strong>用户名</strong>.<a href="https://link.zhihu.com/?target=http://github.io">http://github.io</a> 这个<strong>用户名</strong>使用你的GitHub帐号名称代替，这是固定写法，比如我的仓库名为：<a target="_blank" rel="noopener" href="https://chenjfmorton.github.io/">ChenJFMorton.github.io</a></p>
<h2 id="安装Git"><a href="#安装Git" class="headerlink" title="安装Git"></a>安装Git</h2><p>过程略</p>
<h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><p>Hexo基于Node.js，Node.js下载地址：<a href="https://link.zhihu.com/?target=https://nodejs.org/en/download/">Download | Node.js</a> 下载安装包，注意安装Node.js会包含环境变量及npm的安装，安装后，检测Node.js是否安装成功，在命令行中输入 node -v </p>
<h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>Hexo就是我们的个人博客网站的框架， 这里需要自己在电脑常里创建一个文件夹，可以命名为Blog，Hexo框架与以后你自己发布的网页都在这个文件夹中。</p>
<p>进入文件夹中，使用npm命令安装Hexo，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli </span><br></pre></td></tr></table></figure>

<p>这个安装时间较长耐心等待，安装完成后，初始化我们的博客，输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">npm install </span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<h2 id="发布新文章"><a href="#发布新文章" class="headerlink" title="发布新文章"></a>发布新文章</h2><p>hexo g -d</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/29/20200729_JVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://pic.downk.cc/item/5f277a5a14195aa594cad4d0.jpg">
      <meta itemprop="name" content="Chen Jianfeng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenjf's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/20200729_JVM/" class="post-title-link" itemprop="url">JVM调优及问题排查</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-29 17:15:15" itemprop="dateCreated datePublished" datetime="2020-07-29T17:15:15+08:00">2020-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-18 10:06:31" itemprop="dateModified" datetime="2022-08-18T10:06:31+08:00">2022-08-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/07/29/20200729_JVM/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/07/29/20200729_JVM/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是针对有一定Java虚拟机基础知识后，在实际工作中解决JVM相关问题及如何进行优化，偏方法论。</p>
<h2 id="Java内存区域及收集器介绍"><a href="#Java内存区域及收集器介绍" class="headerlink" title="Java内存区域及收集器介绍"></a>Java内存区域及收集器介绍</h2><center><font color="red">jdk1.7及之前</font></center>

<p><img src="https://pic.downk.cc/item/5f2146e814195aa59465fe0a.png"></p>
<center><font color="red">jdk1.8</font></center>

<p><img src="https://pic.downk.cc/item/5f2146e814195aa59465fe0a.png"></p>
<p>1.8同1.7比，最大的差别就是：<strong>元数据区取代了永久代</strong>。元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代之间最大的区别在于：<strong>元数据空间并不在虚拟机中，而是使用本地内存</strong>。</p>
<p><img src="https://pic.downk.cc/item/5f222aa914195aa594e49ad8.png"></p>
<p>垃圾收集器：</p>
<p>收集算法、垃圾收集器详细介绍：略，待补充。</p>
<p>垃圾收集从2个方面不断的改进：提高垃圾回收效率；提高用户体验（低停顿）；</p>
<p><img src="https://pic.downk.cc/item/5f222c2314195aa594e52e60.png"></p>
<center>HotSpot虚拟机的垃圾收集器（介绍见参考一）</center>
## JVM调优目标

<ul>
<li><p>一、何时需要做jvm调优？</p>
<p>​    1、heap 内存（老年代）持续上涨达到设置的最大内存值；</p>
<p>​    2、Full GC 次数频繁；</p>
<p>​    3、GC 停顿时间过长（超过1秒）；</p>
<p>​    4、应用出现OutOfMemory 等内存异常；</p>
<p>​    5、应用中有使用本地缓存且占用大量内存空间；</p>
<p>​    6、系统吞吐量与响应性能不高或下降。</p>
</li>
<li><p>二、 JVM调优原则</p>
<p>​    1、多数的Java应用不需要在服务器上进行JVM优化；</p>
<p>​    2、多数导致GC问题的Java应用，都不是因为我们参数设置错误，而是代码问题；</p>
<p>​    3、在应用上线之前，先考虑将机器的JVM参数设置到最优（最适合）；</p>
<p>​    4、减少创建对象的数量；</p>
<p>​    5、减少使用全局变量和大对象；</p>
<p>​    6、JVM优化是到最后不得已才采用的手段；</p>
<p>​    7、在实际使用中，分析GC情况优化代码比优化JVM参数更好；</p>
</li>
<li><p>三、 JVM调优目标</p>
<p>​    1、GC低停顿；</p>
<p>​    2、GC低频率；</p>
<p>​    3、低内存占用；</p>
<p>​    4、高吞吐量;</p>
</li>
</ul>
<h2 id="JVM调优参数简介"><a href="#JVM调优参数简介" class="headerlink" title="JVM调优参数简介"></a>JVM调优参数简介</h2><h3 id="堆设置"><a href="#堆设置" class="headerlink" title="堆设置"></a>堆设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-Xmn1200m</td>
<td>设置年轻代大小为1200MB。增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，Sun官方推荐配置为整个堆的3/8</td>
</tr>
<tr>
<td>-Xms4g</td>
<td>初始化堆内存大小为4GB</td>
</tr>
<tr>
<td>-Xmx4g</td>
<td>堆内存最大值为4GB</td>
</tr>
<tr>
<td>-Xss512k</td>
<td>设置每个线程的堆栈大小。JDK5.0以后每个线程堆栈大小为1MB，以前每个线程堆栈大小为256K。应根据应用线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右</td>
</tr>
<tr>
<td>-XX:MaxDirectMemorySize</td>
<td>堆外内存/直接内存的大小，默认为堆内存减去一个Survivor区的大小</td>
</tr>
<tr>
<td>-XX:MaxMetaspaceSize=512m</td>
<td>设置元数据区最大值512M（<font color="red">jdk1.8</font>）</td>
</tr>
<tr>
<td>-XX:MaxPermSize=256m</td>
<td>设置持久代大小为256MB。（<font color="red">jdk1.7及以下</font>）</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold=15</td>
<td>设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论</td>
</tr>
<tr>
<td>-XX:MetaspaceSize=128m</td>
<td>设置元数据区初始值128M（<font color="red">jdk1.8</font>）</td>
</tr>
<tr>
<td>-XX:NewRatio=4</td>
<td>设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1/5</td>
</tr>
<tr>
<td>-XX:PermSize=100m</td>
<td>初始化永久代大小为100MB。（<font color="red">jdk1.7及以下</font>）</td>
</tr>
<tr>
<td>-XX:ReservedCodeCacheSize</td>
<td>JIT编译后二进制代码的存放区，满了之后就不再编译。默认开多层编译240M，可以在JMX里看看CodeCache的大小</td>
</tr>
<tr>
<td>-XX:SurvivorRatio=8</td>
<td>设置年轻代中Eden区与Survivor区的大小比值。设置为8，则两个Survivor区与一个Eden区的比值为2:8，一个Survivor区占整个年轻代的1/10</td>
</tr>
</tbody></table>
<h3 id="GC设置"><a href="#GC设置" class="headerlink" title="GC设置"></a>GC设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+HeapDumpOnOutOfMemoryError</td>
<td>发生内存溢出是进行heap-dump</td>
</tr>
<tr>
<td>-XX:HeapDumpPath=/path/to/java_pid.hprof</td>
<td>这个参数与-XX:+HeapDumpOnOutOfMemoryError共同作用，设置heap-dump时内容输出文件</td>
</tr>
<tr>
<td>-XX:ErrorFile=/path/to/hs_err_pid.log</td>
<td>指定致命错误日志位置。一般在JVM发生致命错误时会输出类似hs_err_pid.log的文件，默认是在工作目录中（如果没有权限，会尝试在/tmp中创建），不过还是自己指定位置更好一些，便于收集和查找，避免丢失</td>
</tr>
<tr>
<td>-XX:StringTableSize=1000003</td>
<td>指定字符串常量池大小，默认值是60013。对Java稍微有点常识的应该知道，字符串是常量，创建之后就不可修改了，这些常量所在的地方叫做字符串常量池。如果自己系统中有很多字符串的操作，且这些字符串值比较固定，在允许的情况下，可以适当调大一些池子大小</td>
</tr>
</tbody></table>
<h3 id="GC日志"><a href="#GC日志" class="headerlink" title="GC日志"></a>GC日志</h3><p>GC过程可以通过GC日志来提供优化依据。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+PrintGCDetails</td>
<td>启用gc日志打印功能</td>
</tr>
<tr>
<td>-Xloggc:/path/to/gc.log</td>
<td>指定gc日志位置</td>
</tr>
<tr>
<td>-XX:+PrintHeapAtGC</td>
<td>打印GC前后的详细堆栈信息</td>
</tr>
<tr>
<td>-XX:+PrintGCDateStamps</td>
<td>打印可读的日期而不是时间戳</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationStoppedTime</td>
<td>打印所有引起JVM停顿时间，如果真的发现了一些不知什么的停顿，再临时加上-XX:+PrintSafepointStatistics -XX: PrintSafepointStatisticsCount=1找原因</td>
</tr>
<tr>
<td>-XX:+PrintGCApplicationConcurrentTime</td>
<td>打印JVM在两次停顿之间正常运行时间，与-XX:+PrintGCApplicationStoppedTime一起使用效果更佳</td>
</tr>
<tr>
<td>-XX:+PrintTenuringDistribution</td>
<td>查看每次minor GC后新的存活周期的阈值</td>
</tr>
<tr>
<td>-XX:+UseGCLogFileRotation 与 -XX:NumberOfGCLogFiles=10 与 -XX:GCLogFileSize=10M</td>
<td>GC日志在重启之后会清空，但是如果一个应用长时间不重启，那GC日志会增加，所以添加这3个参数，是GC日志滚动写入文件，但是如果重启，可能名字会出现混乱</td>
</tr>
<tr>
<td>-XX:PrintFLSStatistics=1</td>
<td>打印每次GC前后内存碎片的统计信息</td>
</tr>
</tbody></table>
<h3 id="收集器"><a href="#收集器" class="headerlink" title="收集器"></a>收集器</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明1</th>
<th>说明2</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>设置<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html#concurrent_mark_sweep_cms_collector">CMS收集器</a> （只针对老年代）</td>
<td>并发收集、低停顿；对CPU资源敏感，CMS默认启动的回收线程数是（CPU数量+3）/4；</td>
</tr>
<tr>
<td>-XX:+UseParNewGC</td>
<td>设置年轻代为多线程收集</td>
<td>可以不设置，jdk 8中设置-XX:+UseConcMarkSweepGC，自动启用-XX:+UseParNewGC</td>
</tr>
<tr>
<td>-XX:+CMSClassUnloadingEnabled</td>
<td>配合-XX:+UseConcMarkSweepGC使用，垃圾回收会清理持久代，移除不再使用的classes</td>
<td></td>
</tr>
<tr>
<td>-XX:+ UseG1GC</td>
<td>允许使用垃圾优先（G1）垃圾收集器。它是一个服务器式垃圾收集器，针对具有大量RAM的多处理器计算机。它以高概率满足GC暂停时间目标，同时保持良好的吞吐量。</td>
<td>G1收集器推荐用于需要大堆（大小约为6 GB或更大）且GC延迟要求有限的应用（稳定且可预测的暂停时间低于0.5秒）。</td>
</tr>
<tr>
<td>G1其他参数详情请见参考一</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="其他参数设置"><a href="#其他参数设置" class="headerlink" title="其他参数设置"></a>其他参数设置</h3><table>
<thead>
<tr>
<th>参数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td>-ea</td>
<td align="left">启用断言，这个没有什么好说的，可以选择启用，或这选择不启用，没有什么大的差异。完全根据自己的系统进行处理</td>
</tr>
<tr>
<td>-XX:+UseThreadPriorities</td>
<td align="left">启用线程优先级，主要是因为我们可以给予周期性任务更低的优先级，以避免干扰客户端工作。在我当前的环境中，是默认启用的</td>
</tr>
<tr>
<td>-XX:ThreadPriorityPolicy=42</td>
<td align="left">允许降低线程优先级</td>
</tr>
<tr>
<td>-XX:+HeapDumpOnOutOfMemoryError</td>
<td align="left">发生内存溢出是进行heap-dump</td>
</tr>
<tr>
<td>-XX:HeapDumpPath=/path/to/java_pid.hprof</td>
<td align="left">这个参数与-XX:+HeapDumpOnOutOfMemoryError共同作用，设置heap-dump时内容输出文件</td>
</tr>
<tr>
<td>-XX:ErrorFile=/path/to/hs_err_pid.log</td>
<td align="left">指定致命错误日志位置。一般在JVM发生致命错误时会输出类似hs_err_pid.log的文件，默认是在工作目录中（如果没有权限，会尝试在/tmp中创建），不过还是自己指定位置更好一些，便于收集和查找，避免丢失</td>
</tr>
<tr>
<td>-XX:StringTableSize=1000003</td>
<td align="left">指定字符串常量池大小，默认值是60013。对Java稍微有点常识的应该知道，字符串是常量，创建之后就不可修改了，这些常量所在的地方叫做字符串常量池。如果自己系统中有很多字符串的操作，且这些字符串值比较固定，在允许的情况下，可以适当调大一些池子大小</td>
</tr>
<tr>
<td>-XX:+AlwaysPreTouch</td>
<td align="left">在启动时把所有参数定义的内存全部捋一遍。使用这个参数可能会使启动变慢，但是在后面内存使用过程中会更快。可以保证内存页面连续分配，新生代晋升时不会因为申请内存页面使GC停顿加长。通常只有在内存大于32G的时候才会有感觉</td>
</tr>
<tr>
<td>-XX:-UseBiasedLocking</td>
<td align="left">禁用偏向锁（在存在大量锁对象的创建且高度并发的环境下(即非多线程高并发应用)禁用偏向锁能够带来一定的性能优化）</td>
</tr>
<tr>
<td>-XX:AutoBoxCacheMax=20000</td>
<td align="left">增加数字对象自动装箱的范围，JDK默认-128～127的int和long，超出范围就会即时创建对象，所以，增加范围可以提高性能，但是也是需要测试</td>
</tr>
<tr>
<td>-XX:-OmitStackTraceInFastThrow</td>
<td align="left">不忽略重复异常的栈，这是JDK的优化，大量重复的JDK异常不再打印其StackTrace。但是如果系统是长时间不重启的系统，在同一个地方跑了N多次异常，结果就被JDK忽略了，那岂不是查看日志的时候就看不到具体的StackTrace，那还怎么调试，所以还是关了的好</td>
</tr>
<tr>
<td>-XX:+PerfDisableSharedMem</td>
<td align="left">启用标准内存使用。JVM控制分为标准或共享内存，区别在于一个是在JVM内存中，一个是生成/tmp/hsperfdata_{userid}/{pid}文件，存储统计数据，通过mmap映射到内存中，别的进程可以通过文件访问内容。通过这个参数，可以禁止JVM写在文件中写统计数据，代价就是jps、jstat这些命令用不了了，只能通过jmx获取数据。但是在问题排查是，jps、jstat这些小工具是很好用的，比jmx这种很重的东西好用很多，所以需要自己取舍。这里有个GC停顿的例子</td>
</tr>
<tr>
<td>-Djava.net.preferIPv4Stack=true</td>
<td align="left">这个参数是属于网络问题的一个参数，可以根据需要设置。在某些开启ipv6的机器中，通过InetAddress.getLocalHost().getHostName()可以获取完整的机器名，但是在ipv4的机器中，可能通过这个方法获取的机器名不完整，可以通过这个参数来获取完整机器名</td>
</tr>
</tbody></table>
<h2 id="JVM如何调优"><a href="#JVM如何调优" class="headerlink" title="JVM如何调优"></a>JVM如何调优</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>​    第1步：分析GC日志（详见参考四、五）及dump文件，判断是否需要优化，确定瓶颈问题点；</p>
<p> 第2步：确定JVM调优量化目标；</p>
<p>​    第3步：确定JVM调优参数（根据历史JVM参数来调整）；<br>  调优步骤：<br>    1、确定老年代内存占用大小，使用以下命令, concurrent mark-sweep generation项对应的used就是老年代的内存占用<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -heap 【pid】</span><br></pre></td></tr></table></figure><br>    2、设置堆内存大小，-Xms、-Xmx，建议-Xms=-Xmx，Xmx 和 Xms设置为老年代存活对象的3-4倍，即FullGC之后的老年代内存占用的3-4倍，参考<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1695047"><font color="red">Xms和Xmx参数设置为相同值好处</font></a><br>    3、设置年轻代内存大小，-Xmn，建议整个堆3/8<br>    4、设置元空间大小，-XX:MetaspaceSize、-XX:MaxMetaspaceSize，建议MetaspaceSize和MaxMetaspaceSize设置一样大，具体设置多大，建议稳定运行一段时间后通过jstat -gc pid确认且这个值大一些，对于大部分项目256m即可，参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b448c21d2e71"><font color="red">MetaspaceSize的误解</font></a>，<a target="_blank" rel="noopener" href="http://lovestblog.cn/blog/2016/10/29/metaspace/"><font color="red">Metaspace解密</font></a></p>
<p>​    第4步：调优一台服务器，对比观察调优前后的差异；</p>
<p>​    第5步：不断的分析和调整，直到找到合适的JVM参数配置；</p>
<p>​    第6步：找到最合适的参数，将这些参数应用到所有服务器，并进行后续跟踪。</p>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p>jps：查询java进程</p>
<p>jstat：虚拟机运行状态信息</p>
<p>jmap：生成堆存储快照</p>
<p>jstack：生成虚拟机当前时刻的线程快照，帮助定位线程出现长时间停顿的原因</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c6a04c88900a">https://www.jianshu.com/p/c6a04c88900a</a></p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>不同的环境有不同的方案，可以参考，不过还是建议在自己的环境中有针对的验证之后再使用，毕竟各自的环境都有差异。</p>
<h3 id="gc查看"><a href="#gc查看" class="headerlink" title="gc查看"></a>gc查看</h3><p>查看gc.log状态，可参考 <font color="red">参考四、参考五</font>；</p>
<p>结论：没有Full GC；每次从年轻代移到了老年代的内存占老年代总内存比例并不大：</p>
<p><img src="https://pic.downk.cc/item/5f223ba014195aa594eca7aa.png"></p>
<p>查看star.hprof文件（使用JProfiler），如果有的话；</p>
<p>查询某一时刻虚拟机运行状态；</p>
<p>./jdk/jdk1.8.0_101/bin/jstat -gc 【pid】 3600s</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>设置的值</th>
</tr>
</thead>
<tbody><tr>
<td>S0C</td>
<td>Survivor0空间的大小。单位KB。</td>
<td>316992.0（0.3G）</td>
</tr>
<tr>
<td>S1C</td>
<td>Survivor1空间的大小。单位KB。</td>
<td>316992.0（0.3G）</td>
</tr>
<tr>
<td>S0U</td>
<td>Survivor0已用空间的大小。单位KB。</td>
<td>0</td>
</tr>
<tr>
<td>S1U</td>
<td>Survivor1已用空间的大小。单位KB。</td>
<td>17521.7</td>
</tr>
<tr>
<td>EC</td>
<td>Eden空间的大小。单位KB。</td>
<td>2536320.0（2.4G）</td>
</tr>
<tr>
<td>EU</td>
<td>Eden已用空间的大小。单位KB。</td>
<td></td>
</tr>
<tr>
<td>OC</td>
<td>老年代空间的大小。单位KB。</td>
<td>3121152.0（3G）</td>
</tr>
<tr>
<td>OU</td>
<td>老年代已用空间的大小。单位KB。</td>
<td>221391（0.21G）</td>
</tr>
<tr>
<td>MC</td>
<td>方法区大小</td>
<td>125824.0（0.12G）</td>
</tr>
<tr>
<td>MU</td>
<td>方法区使用大小</td>
<td>119041（0.11G）</td>
</tr>
<tr>
<td>CCSC</td>
<td>压缩类空间大小</td>
<td>13824.0（0.01G）</td>
</tr>
<tr>
<td>CCSU</td>
<td>压缩类空间使用大小</td>
<td>12536</td>
</tr>
<tr>
<td>YGC</td>
<td>年轻代垃圾回收次数</td>
<td>261</td>
</tr>
<tr>
<td>YGCT</td>
<td>年轻代垃圾回收消耗时间</td>
<td>10.931（0.04s/次）</td>
</tr>
<tr>
<td>FGC</td>
<td>老年代垃圾回收次数</td>
<td>0</td>
</tr>
<tr>
<td>FGCT</td>
<td>老年代垃圾回收消耗时间</td>
<td>0</td>
</tr>
<tr>
<td>GCT</td>
<td>垃圾回收消耗总时间</td>
<td>10.931</td>
</tr>
</tbody></table>
<h4 id="查看系统jvm参数状态"><a href="#查看系统jvm参数状态" class="headerlink" title="查看系统jvm参数状态"></a>查看系统jvm参数状态</h4><p>机器状况</p>
<table>
<thead>
<tr>
<th>内存</th>
<th>CPU</th>
<th>磁盘空间</th>
</tr>
</thead>
<tbody><tr>
<td>8G</td>
<td>4*4</td>
<td>60G</td>
</tr>
</tbody></table>
<p>当前jvm参数配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms6144m -Xmx6144m -XX:MaxPermSize=256m -verbose:gc -XX:+PrintGCDetails -Xloggc:/../tomcat/logs/gc.log -XX:+PrintGCTimeStamps -XX:+PrintGCDetails -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -Xmn3096m -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSClassUnloadingEnabled -XX:+ExplicitGCInvokesConcurrent -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/../tomcat/logs/star.hprof </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">参数</td>
<td align="left">说明</td>
<td align="left">建议</td>
</tr>
<tr>
<td align="left">-Xms6144m</td>
<td align="left">初始化堆内存大小为6GB</td>
<td align="left">低于系统内存</td>
</tr>
<tr>
<td align="left">-Xmx6144m</td>
<td align="left">堆内存最大值为6GB</td>
<td align="left">低于系统内存</td>
</tr>
<tr>
<td align="left"><del>-XX:MaxPermSize=256m</del></td>
<td align="left">设置永久代最大为256MB（无用）</td>
<td align="left">jdk1.8不需要设置</td>
</tr>
<tr>
<td align="left">-verbose:gc</td>
<td align="left">输出虚拟机中GC的详细情况</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+PrintGCDetails</td>
<td align="left">输出虚拟机中GC的详细情况</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-Xloggc:/../tomcat/logs/gc.log</td>
<td align="left">设置gc日志文件位子</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+PrintGCTimeStamps</td>
<td align="left">打印gc时间时间戳，gc.log</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:MetaspaceSize=256m</td>
<td align="left">设置元数据区初始值256M （永久代）</td>
<td align="left">该值越大触发Full GC的时机就越晚，</td>
</tr>
<tr>
<td align="left">-XX:MaxMetaspaceSize=256m</td>
<td align="left">设置元数据区最大值256M （永久代）</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-Xmn3096m</td>
<td align="left">设置年轻代区域3G</td>
<td align="left">Sun官方推荐配置为整个堆的3/8</td>
</tr>
<tr>
<td align="left">-XX:+UseConcMarkSweepGC</td>
<td align="left">设置<font color="red"><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html#concurrent_mark_sweep_cms_collector">CMS收集器</a> （只针对老年代）</font></td>
<td align="left">并发收集、低停顿；对CPU资源敏感，CMS默认启动的回收线程数是（CPU数量+3）/4；</td>
</tr>
<tr>
<td align="left"><del>-XX:+UseParNewGC</del></td>
<td align="left">设置<font color="red">年轻代为多线程收集</font></td>
<td align="left">可以不设置，jdk 8中设置-XX:+UseConcMarkSweepGC，自动启用-XX:+UseParNewGC</td>
</tr>
<tr>
<td align="left">-XX:+CMSClassUnloadingEnabled</td>
<td align="left">配合-XX:+UseConcMarkSweepGC使用，垃圾回收会清理持久代，移除不再使用的classes</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+ExplicitGCInvokesConcurrent</td>
<td align="left">允许使用<code>System.gc()</code>请求调用并发GC 。默认情况下禁用此选项，并且只能与该<code>-XX:+UseConcMarkSweepGC</code>选项一起启用</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses</td>
<td align="left">通过<code>System.gc()</code>在并发GC周期期间使用请求和卸载类，可以调用并发GC。默认情况下禁用此选项，并且只能与该<code>-XX:+UseConcMarkSweepGC</code>选项一起启用</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:+HeapDumpOnOutOfMemoryError</td>
<td align="left">通过使用堆分析器（HPROF）将Java堆转储到当前目录中的文件</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-XX:HeapDumpPath=/home/ewallet/loan-star/loan-star-pre/default/tomcat/logs/star.hprof</td>
<td align="left">设置用于写入堆分析器（HPROF）提供的堆转储的路径和文件名。默认情况下，该文件在当前工作目录中创建，并且名为java_pidpid.hprof，其中pid是导致错误的进程的标识符</td>
<td align="left"></td>
</tr>
</tbody></table>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>当前机器的配置足够，在目前情况下优化参数不会有太大的提升效果。</p>
<p>假如在降低机器配置前提下，那需要依赖数据，做相应的调整，具体要看机器成本而定。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h4 id="附一-找到占用cpu最高的一个线程"><a href="#附一-找到占用cpu最高的一个线程" class="headerlink" title="附一 找到占用cpu最高的一个线程"></a>附一 找到占用cpu最高的一个线程</h4><ul>
<li><p>第一步，找到占用cpu最高的一个线程pid</p>
<p>方法：直接top,然后shift+h</p>
</li>
<li><p>第二步，将其转化成16进制。假使我们得到的线程号为【n】，接下来将它转成16进制，记为spid</p>
<p>方法：printf 0x%x 【n】</p>
</li>
<li><p>第三步，执行jstack -l 【pid】| grep 【spid】 -A 100 打印后面100行分析问题</p>
<p>插件使用：<a target="_blank" rel="noopener" href="https://github.com/oldratlee/useful-scripts">https://github.com/oldratlee/useful-scripts</a></p>
</li>
</ul>
<h4 id="附二-参考资料"><a href="#附二-参考资料" class="headerlink" title="附二 参考资料"></a>附二 参考资料</h4><p>参考一：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html </a>（ <font color="red">参数</font>）</p>
<p>​       <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html%EF%BC%88">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/index.html（</a><font color="red">收集器</font>）</p>
<p>​       <a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/tuning-139912.html%EF%BC%88">https://www.oracle.com/technetwork/java/tuning-139912.html（</a><font color="red">调优试例</font>）</p>
<p>参考二：书籍：深入理解Java虚拟机（第二版） </p>
<p>​       书籍：Java Performance：The Definitive Guide</p>
<p> 参考三：<a target="_blank" rel="noopener" href="https://blog.csdn.net/linhu007/article/details/48897597%EF%BC%88">https://blog.csdn.net/linhu007/article/details/48897597（</a><font color="red">CMS与G1</font>）</p>
<p>参考四：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zc19921215/article/details/83029952">https://blog.csdn.net/zc19921215/article/details/83029952</a></p>
<p>参考五：<a target="_blank" rel="noopener" href="https://www.aliyun.com/jiaocheng/1341282.html">https://www.aliyun.com/jiaocheng/1341282.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chen Jianfeng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>


  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: location.pathname,
    }, {"enable":true,"appId":"1kVszHAOMaqpz0p9HaUY4jS3-9Nh9j0Va","appKey":"GKfDomM0s9bBI7BLr9K1iSvR","placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"language":"zh-cn","visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
